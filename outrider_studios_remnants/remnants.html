
<input name="attr_template_start" value="&{template:rapidfire} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{system=@{system}}}" type="hidden" title="@{template_start}"/>
<input name="attr_collapsed" value="" type="hidden" title="@{collapsed}"/>
<input name="attr_system" value="remnants" type="hidden" title="@{system}"/>
<main class="subsystem-style system-remnant" id="main">
  <input class="sheet-state" name="attr_sheet_state" value="settings" type="hidden" title="@{sheet_state}"/>
  <input name="attr_system_header" type="hidden" title="@{system_header}"/><img class="system-header subsystem-display remnants" name="attr_system_header" role="heading" aria-level="1" data-i18n="system header" data-i18n-alt="system header" title="@{system_header}"/>
  <h1 class="system-header subsystem-display warbirds" data-i18n="warbirds"></h1>
  <nav class="subsystem-style system-remnant" id="main-nav">
    <button class="nav__button nav__button--tab nav__button--tab--left character" name="act_nav-character" data-i18n="character" role="heading" aria-level="4" type="action" title="%{nav-character}">
    </button>
    <button class="nav__button nav__button--tab nav__button--tab--left npc" name="act_nav-npc" data-i18n="npc" role="heading" aria-level="4" type="action" title="%{nav-npc}">
    </button>
    <button class="active nav__button nav__button--settings settings" name="act_nav-settings" type="action" title="%{nav-settings}">y
    </button>
    <button class="nav__button nav__button--tab nav__button--tab--right battle-remnant subsystem-display remnants" name="act_nav-battle-remnant" data-i18n="battle remnant" role="heading" aria-level="4" type="action" title="%{nav-battle-remnant}">
    </button>
  </nav>
  <article class="subsystem-style system-remnant settings active navigable-section" id="settings">
    <section class="section" id="system-behavior">
      <label class="input-label"><span class="input-label__text" data-i18n="difficulty automation" role="heading" aria-level="4"></span>
        <input class="box input-label__input" name="attr_difficulty" value="1" checked="" type="checkbox" title="@{difficulty}"/>
      </label>
      <label class="input-label"><span class="input-label__text" data-i18n="action penalty automation" role="heading" aria-level="4"></span>
        <select class="underlined input-label__input" name="attr_action_penalty_automation" title="@{action_penalty_automation}">
          <option value="disabled" data-i18n="disabled">
          </option>
          <option value="ask" data-i18n="ask">
          </option>
          <option value="use input" data-i18n="use input">
          </option>
        </select>
      </label>
      <label class="input-label"><span class="input-label__text" data-i18n="sheet type" role="heading" aria-level="4"></span>
        <select class="underlined input-label__input" name="attr_sheet_type" title="@{sheet_type}">
          <option value="character" data-i18n="character" selected="">
          </option>
          <option value="npc" data-i18n="npc">
          </option>
        </select>
      </label>
    </section>
    <section class="section" id="sheet-behavior">
      <label class="input-label"><span class="input-label__text" data-i18n="whisper rolls to gm" role="heading" aria-level="4"></span>
        <select class="underlined input-label__input" name="attr_whisper" title="@{whisper}">
          <option value=" " data-i18n="never" selected="">
          </option>
          <option value="/w gm " data-i18n="always">
          </option>
          <option value="?{Whisper|No, |Yes,/w gm }" data-i18n="ask">
          </option>
        </select>
      </label>
    </section>
  </article>
  <article class="character navigable-section" id="character">
    <section class="section" id="character-info">
      <h2 data-i18n="character info">
      </h2>
      <label class="input-label"><span class="input-label__text" data-i18n="character name" role="heading" aria-level="5"></span>
        <input class="underlined character_name input-label__input" name="attr_character_name" type="text" title="@{character_name}"/>
      </label>
      <label class="input-label"><span class="input-label__text" data-i18n="player name" role="heading" aria-level="5"></span>
        <input class="underlined player_name input-label__input" name="attr_player_name" type="text" title="@{player_name}"/>
      </label>
      <label class="input-label"><span class="input-label__text" data-i18n="nationality" role="heading" aria-level="5"></span>
        <input class="underlined nationality input-label__input" name="attr_nationality" type="text" title="@{nationality}"/>
      </label>
      <label class="input-label"><span class="input-label__text" data-i18n="organization affiliations" role="heading" aria-level="5"></span>
        <input class="underlined organization_affiliations input-label__input" name="attr_organization_affiliations" type="text" title="@{organization_affiliations}"/>
      </label>
      <div class="headed-textarea appearance">
        <h5 data-i18n="appearance / mannerisms">
        </h5>
        <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_appearance/mannerisms" title="@{appearance/mannerisms}"></span>
          <textarea class="underlined adaptive--text__textarea" name="attr_appearance/mannerisms" title="@{appearance/mannerisms}"></textarea>
        </div>
      </div>
      <div class="health-track">
        <h2 class="health-track__header" data-i18n="health track">
        </h2>
        <input class="health-track__max-control" name="attr_health_max" value="1" type="hidden" title="@{health|max}"/>
        <fieldset class="repeating_health">
          <input class="health-track__fill-control" name="attr_fill" hidden="" value="1" type="checkbox" title="@{repeating_health_$X_fill}"/>
          <input class="health-track__clear-control health-track__checkbox" name="attr_damaged" value="1" type="checkbox" title="@{repeating_health_$X_damaged}"/>
          <button class="health-track__clearer" name="act_clear" type="action" title="%{repeating_health_$X_clear}">
          </button>
          <input class="boxed health-track__number" name="attr_penalty" type="number" title="@{repeating_health_$X_penalty}"/>
        </fieldset>
      </div>
    </section>
    <section class="stat-grid section repeating-container" id="stats">
      <h2 data-i18n="stats">
      </h2>
      <label class="input-label stat_points"><span class="input-label__text" data-i18n="stat points" role="heading" aria-level="4"></span>
        <input class="boxed input-label__input" name="attr_stat_points" type="number" title="@{stat_points}"/>
      </label>
      <label class="input-label reserve"><span class="input-label__text" data-i18n="reserve" role="heading" aria-level="4"></span>
        <input class="boxed input-label__input" name="attr_reserve" type="number" title="@{reserve}"/>
      </label>
      <button class="roller" name="roll_body" role="heading" aria-level="4" data-i18n="body" value="@{body_action}" title="%{body}" type="roll">
      </button>
      <button name="act_body-action" hidden="" type="action" title="%{body-action}">
      </button>
      <input name="attr_body_action" type="hidden" title="@{body_action}"/>
      <select class="boxed number" name="attr_body" title="@{body}">
        <option value="3">3
        </option>
        <option value="2">2
        </option>
        <option value="1">1
        </option>
        <option value="0" selected="">0
        </option>
        <option value="-1">-1
        </option>
        <option value="-2">-2
        </option>
        <option value="-3">-3
        </option>
      </select>
      <input class="boxed" name="attr_body_mod" type="number" title="@{body_mod}"/>
      <button class="roller" name="roll_mind" role="heading" aria-level="4" data-i18n="mind" value="@{mind_action}" title="%{mind}" type="roll">
      </button>
      <button name="act_mind-action" hidden="" type="action" title="%{mind-action}">
      </button>
      <input name="attr_mind_action" type="hidden" title="@{mind_action}"/>
      <select class="boxed number" name="attr_mind" title="@{mind}">
        <option value="3">3
        </option>
        <option value="2">2
        </option>
        <option value="1">1
        </option>
        <option value="0" selected="">0
        </option>
        <option value="-1">-1
        </option>
        <option value="-2">-2
        </option>
        <option value="-3">-3
        </option>
      </select>
      <input class="boxed" name="attr_mind_mod" type="number" title="@{mind_mod}"/>
      <button class="roller" name="roll_spirit" role="heading" aria-level="4" data-i18n="spirit" value="@{spirit_action}" title="%{spirit}" type="roll">
      </button>
      <button name="act_spirit-action" hidden="" type="action" title="%{spirit-action}">
      </button>
      <input name="attr_spirit_action" type="hidden" title="@{spirit_action}"/>
      <select class="boxed number" name="attr_spirit" title="@{spirit}">
        <option value="3">3
        </option>
        <option value="2">2
        </option>
        <option value="1">1
        </option>
        <option value="0" selected="">0
        </option>
        <option value="-1">-1
        </option>
        <option value="-2">-2
        </option>
        <option value="-3">-3
        </option>
      </select>
      <input class="boxed" name="attr_spirit_mod" type="number" title="@{spirit_mod}"/>
      <div class="repeating-container__equipment equipment subsection">
        <h2 data-i18n="gear and money">
        </h2>
        <label class="input-label subsystem-display remnants"><span class="input-label__text" data-i18n="easy living" role="heading" aria-level="4"></span>
          <input class="boxed input-label__input" name="attr_easy_living" type="number" title="@{easy_living}"/>
        </label>
        <div class="flex-box space-between subsystem-display warbirds">
          <label class="input-label"><span class="input-label__text" data-i18n="fame" role="heading" aria-level="4"></span>
            <input class="boxed input-label__input" name="attr_fame" type="number" value="2" title="@{fame}"/>
          </label>
          <label class="input-label"><span class="input-label__text" data-i18n="fame points" role="heading" aria-level="4"></span>
            <input class="boxed input-label__input" name="attr_fame_points" type="number" title="@{fame_points}"/>
          </label>
        </div>
        <div class="repeat-columns">
          <h5 data-i18n="name"></h5>
          <h5 data-i18n="quantity abbreviation"></h5>
        </div>
        <button class="repcontrol-button repcontrol-button--add" name="act_add-equipment" type="action" title="%{add-equipment}">
        </button>
        <button class="repcontrol-button repcontrol-button--edit" name="act_edit-equipment" type="action" title="%{edit-equipment}">
        </button>
        <fieldset class="repeating_equipment">
          <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_equipment_$X_collapse}"/>
          <input class="underlined" name="attr_name" role="heading" aria-level="3" type="text" title="@{repeating_equipment_$X_name}"/>
          <input class="underlined" name="attr_quantity" type="number" title="@{repeating_equipment_$X_quantity}"/>
          <div class="headed-textarea notes expanded">
            <h5 data-i18n="notes">
            </h5>
            <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_equipment_$X_notes}"></span>
              <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_equipment_$X_notes}"></textarea>
            </div>
          </div>
        </fieldset>
      </div>
    </section>
    <section class="section" id="secondary">
      <div class="secondaries stat-grid">
        <h2 data-i18n="secondary stats">
        </h2>
        <button class="initiative-label span-2 roller" name="roll_initiative" data-i18n="initiative" role="heading" aria-level="4" value="@{initiative_action}" title="%{initiative}" type="roll">
        </button>
        <button name="act_initiative-action" hidden="" type="action" title="%{initiative-action}">
        </button>
        <input name="attr_initiative_action" type="hidden" title="@{initiative_action}"/>
        <input class="boxed initiative" name="attr_initiative" readonly="" value="0" type="number" title="@{initiative}"/>
        <input class="boxed initiative_mod" name="attr_initiative_mod" type="number" title="@{initiative_mod}"/>
        <label class="defence-label span-2" for="defence-mod" data-i18n="defence" role="heading" aria-level="4"></label>
        <input class="boxed defence" name="attr_defence" readonly="" value="3" type="number" title="@{defence}"/>
        <input class="boxed defence_mod" name="attr_defence_mod" id="defence-mod" type="number" title="@{defence_mod}"/>
        <label class="resist-label span-2" for="resist-mod" data-i18n="resist" role="heading" aria-level="4"></label>
        <input class="boxed resist" name="attr_resist" readonly="" value="0" type="number" title="@{resist}"/>
        <input class="boxed resist_mod" name="attr_resist_mod" id="resist-mod" type="number" title="@{resist_mod}"/>
        <label class="health-label" for="health" data-i18n="health" role="heading" aria-level="4"></label>
        <div class="boxed span-2">
          <input name="attr_health" id="health" type="number" title="@{health}"/><span class="slash">/</span>
          <input name="attr_health_max" readonly="" type="number" title="@{health|max}"/>
        </div>
        <input class="boxed health_mod" name="attr_health_mod" type="number" title="@{health_mod}"/>
      </div>
      <div class="combat-gear stat-grid">
        <h2 data-i18n="combat gear">
        </h2>
        <label class="input-label armour bonus contents"><span class="input-label__text" data-i18n="armour bonus" role="heading" aria-level="4"></span>
          <input class="boxed input-label__input" name="attr_armour_bonus" type="number" title="@{armour_bonus}"/>
        </label>
        <label class="input-label shield bonus contents"><span class="input-label__text" data-i18n="shield bonus" role="heading" aria-level="4"></span>
          <input class="boxed input-label__input" name="attr_shield_bonus" type="number" title="@{shield_bonus}"/>
        </label>
        <label class="input-label action penalty contents"><span class="input-label__text" data-i18n="action penalty" role="heading" aria-level="4"></span>
          <input class="boxed input-label__input" name="attr_action_penalty" type="number" title="@{action_penalty}"/>
        </label>
      </div>
    </section>
    <section class="repeating-container--skill repeating-container section" id="skill">
      <h2 data-i18n="skills"></h2>
      <div class="repeat-columns">
        <h5 data-i18n="skills"></h5>
        <h5 data-i18n="level"></h5>
        <h5 data-i18n="stat"></h5>
        <h5 data-i18n="xp"></h5>
      </div>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-skill" type="action" title="%{add-skill}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-skill" type="action" title="%{edit-skill}">
      </button>
      <fieldset class="repeating_skill">
        <input class="raw-control" name="attr_raw" hidden="" value="1" type="checkbox" title="@{repeating_skill_$X_raw}"/>
        <button class="raw roller" name="roll_roll" value="@{action}" title="%{repeating_skill_$X_roll}" type="roll"><span name="attr_name" data-i18n-dynamic="" role="heading" aria-level="5" title="@{repeating_skill_$X_name}"></span>
        </button>
        <button name="act_action" hidden="" type="action" title="%{repeating_skill_$X_action}">
        </button>
        <input name="attr_action" type="hidden" title="@{repeating_skill_$X_action}"/>
        <button class="custom roller" name="roll_roll" value="@{action}" title="%{repeating_skill_$X_roll}" type="roll">
        </button>
        <button name="act_action" hidden="" type="action" title="%{repeating_skill_$X_action}">
        </button>
        <input name="attr_action" type="hidden" title="@{repeating_skill_$X_action}"/>
        <input class="custom underlined" name="attr_name" role="heading" aria-level="5" type="text" title="@{repeating_skill_$X_name}"/>
        <input class="underlined" name="attr_level" type="number" title="@{repeating_skill_$X_level}"/>
        <select class="underlined" name="attr_stat" title="@{repeating_skill_$X_stat}">
          <option value="query" data-i18n="ask" selected="">
          </option>
          <option value="body" data-i18n="body">
          </option>
          <option value="mind" data-i18n="mind">
          </option>
          <option value="spirit" data-i18n="spirit">
          </option>
        </select>
        <input class="underlined" name="attr_xp" type="number" title="@{repeating_skill_$X_xp}"/>
      </fieldset>
    </section>
    <section id="adjustments">
      <div class="repeating-container repeating-container--advantages advantages subsection section">
        <h2 data-i18n="advantages">
        </h2>
        <div class="repeat-columns">
          <h5 data-i18n="name"></h5>
        </div>
        <button class="repcontrol-button repcontrol-button--add" name="act_add-advantage" type="action" title="%{add-advantage}">
        </button>
        <button class="repcontrol-button repcontrol-button--edit" name="act_edit-advantage" type="action" title="%{edit-advantage}">
        </button>
        <fieldset class="repeating_advantage">
          <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_advantage_$X_collapse}"/>
          <input class="underlined" name="attr_name" role="heading" aria-level="3" type="text" title="@{repeating_advantage_$X_name}"/>
          <div class="headed-textarea notes expanded">
            <h5 data-i18n="notes">
            </h5>
            <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_advantage_$X_notes}"></span>
              <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_advantage_$X_notes}"></textarea>
            </div>
          </div>
        </fieldset>
      </div>
      <div class="repeating-container repeating-container--disadvantages disadvantages subsection section">
        <h2 data-i18n="disadvantages">
        </h2>
        <div class="repeat-columns">
          <h5 data-i18n="name"></h5>
        </div>
        <button class="repcontrol-button repcontrol-button--add" name="act_add-disadvantage" type="action" title="%{add-disadvantage}">
        </button>
        <button class="repcontrol-button repcontrol-button--edit" name="act_edit-disadvantage" type="action" title="%{edit-disadvantage}">
        </button>
        <fieldset class="repeating_disadvantage">
          <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_disadvantage_$X_collapse}"/>
          <input class="underlined" name="attr_name" role="heading" aria-level="3" type="text" title="@{repeating_disadvantage_$X_name}"/>
          <div class="headed-textarea notes expanded">
            <h5 data-i18n="notes">
            </h5>
            <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_disadvantage_$X_notes}"></span>
              <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_disadvantage_$X_notes}"></textarea>
            </div>
          </div>
        </fieldset>
      </div>
      <div class="repeating-container repeating-container--adjustments adjustments subsection section">
        <h2 data-i18n="adjustments">
        </h2>
        <div class="repeat-columns">
          <h5 data-i18n="name"></h5>
        </div>
        <button class="repcontrol-button repcontrol-button--add" name="act_add-adjustment" type="action" title="%{add-adjustment}">
        </button>
        <button class="repcontrol-button repcontrol-button--edit" name="act_edit-adjustment" type="action" title="%{edit-adjustment}">
        </button>
        <fieldset class="repeating_adjustment">
          <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_adjustment_$X_collapse}"/>
          <input class="underlined" name="attr_name" role="heading" aria-level="3" type="text" title="@{repeating_adjustment_$X_name}"/>
          <div class="headed-textarea mod expanded">
            <h5 data-i18n="notes">
            </h5>
            <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_adjustment_$X_notes}"></span>
              <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_adjustment_$X_notes}"></textarea>
            </div>
          </div>
        </fieldset>
      </div>
    </section>
    <section class="repeating-container--weapon repeating-container section" id="weapon">
      <h2 data-i18n="weapons"></h2>
      <div class="repeat-columns">
        <h5 data-i18n="weapon"></h5>
        <h5 data-i18n="skill"></h5>
        <h5 data-i18n="damage"></h5>
      </div>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-weapon" type="action" title="%{add-weapon}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-weapon" type="action" title="%{edit-weapon}">
      </button>
      <fieldset class="repeating_weapon">
        <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_weapon_$X_collapse}"/>
        <button class="roller" name="roll_roll" value="@{action}" title="%{repeating_weapon_$X_roll}" type="roll">
        </button>
        <button name="act_action" hidden="" type="action" title="%{repeating_weapon_$X_action}">
        </button>
        <input name="attr_action" type="hidden" title="@{repeating_weapon_$X_action}"/>
        <input class="underlined" name="attr_name" type="text" title="@{repeating_weapon_$X_name}"/>
        <input name="attr_skill" value="select" type="hidden" title="@{repeating_weapon_$X_skill}"/>
        <button class="pseudo-select" name="act_skill-action" type="action" title="%{repeating_weapon_$X_skill-action}">
          <input class="translate-control" name="attr_translate_skill" hidden="" value="1" checked="" type="checkbox" title="@{repeating_weapon_$X_translate_skill}"/><span class="underlined translated" name="attr_skill" data-i18n-dynamic="" title="@{repeating_weapon_$X_skill}"></span><span class="underlined untranslated" name="attr_skill" title="@{repeating_weapon_$X_skill}"></span>
        </button>
        <div class="roll-plus"><span data-i18n="lead"></span><span class="plus">+</span>
          <input class="underlined" name="attr_damage" type="number" title="@{repeating_weapon_$X_damage}"/>
        </div>
        <div class="headed-textarea notes expanded">
          <h5 data-i18n="notes">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_weapon_$X_notes}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_weapon_$X_notes}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
  </article>
  <article class="battle-remnant subsystem-style system-remnant" id="remnant">
    <section class="section" id="remnant-pic">
      <div class="health-track">
        <h2 class="health-track__header" data-i18n="structure track">
        </h2>
        <input class="health-track__max-control" name="attr_remnant_structure_max" value="1" type="hidden" title="@{remnant_structure|max}"/>
        <fieldset class="repeating_remnant-structure">
          <input class="health-track__fill-control" name="attr_fill" hidden="" value="1" type="checkbox" title="@{repeating_remnant-structure_$X_fill}"/>
          <input class="health-track__clear-control health-track__checkbox" name="attr_damaged" value="1" type="checkbox" title="@{repeating_remnant-structure_$X_damaged}"/>
          <button class="health-track__clearer" name="act_clear" type="action" title="%{repeating_remnant-structure_$X_clear}">
          </button>
          <input class="boxed health-track__number" name="attr_penalty" type="number" title="@{repeating_remnant-structure_$X_penalty}"/>
        </fieldset>
      </div>
      <label class="input-label"><span class="input-label__text" data-i18n="duress" role="heading" aria-level="2"></span>
        <input class="boxed input-label__input" name="attr_duress" type="number" title="@{duress}"/>
      </label>
      <div class="image-container remnant-token">
        <label class="input-label image-container__input stacked"><span class="input-label__text" data-i18n="image prompt" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_remnant_token" type="text" value="https://s3.amazonaws.com/files.d20.io/images/259054779/OzN3yQwg7MbfXNtMYs-iOg/original.png" title="@{remnant_token}"/>
        </label>
        <button class="image-container__button" name="act_remnant-token" type="action" title="%{remnant-token}"><img class="image-container__image" name="attr_remnant_token" src="https://s3.amazonaws.com/files.d20.io/images/259054779/OzN3yQwg7MbfXNtMYs-iOg/original.png" data-i18n-alt="remnant token" title="@{remnant_token}"/>
        </button>
      </div>
    </section>
    <section class="stat-grid section" id="remnant-ratings">
      <h2 data-i18n="total ratings">
      </h2>
      <button class="uppercase roller" name="roll_situational_awareness" role="heading" aria-level="4" data-i18n="situation awareness abbreviation" value="@{situational_awareness_action}" title="%{situational_awareness}" type="roll">
      </button>
      <button name="act_situational-awareness-action" hidden="" type="action" title="%{situational-awareness-action}">
      </button>
      <input name="attr_situational_awareness_action" type="hidden" title="@{situational_awareness_action}"/>
      <input class="boxed" name="attr_situational_awareness" readonly="" type="number" title="@{situational_awareness}"/>
      <input class="boxed" name="attr_situational_awareness_mod" type="number" title="@{situational_awareness_mod}"/>
      <h4 data-i18n="defence"></h4>
      <input class="boxed" name="attr_remnant_defence" readonly="" type="number" title="@{remnant_defence}"/>
      <input class="boxed" name="attr_remnant_defence_mod" type="number" title="@{remnant_defence_mod}"/>
      <button class="roller" name="roll_remnant_initiative" data-i18n="initiative" role="heading" aria-level="4" value="@{remnant_initiative_action}" title="%{remnant_initiative}" type="roll">
      </button>
      <button name="act_remnant-initiative-action" hidden="" type="action" title="%{remnant-initiative-action}">
      </button>
      <input name="attr_remnant_initiative_action" type="hidden" title="@{remnant_initiative_action}"/>
      <input class="boxed" name="attr_remnant_initiative" readonly="" type="number" title="@{remnant_initiative}"/>
      <input class="boxed" name="attr_remnant_initiative_mod" type="number" title="@{remnant_initiative_mod}"/>
      <div class="remnant-skills">
        <h2 data-i18n="skills">
        </h2>
        <div class="repeat-columns"> 
          <h5 data-i18n="skill">
          </h5>
          <h5 data-i18n="level">
          </h5>
          <h5 data-i18n="xp">
          </h5>
        </div>
        <button class="roller" name="roll_assault_roll" data-i18n="assault" role="heading" aria-level="4" value="@{assault_action}" title="%{assault_roll}" type="roll">
        </button>
        <button name="act_assault-action" hidden="" type="action" title="%{assault-action}">
        </button>
        <input name="attr_assault_action" type="hidden" title="@{assault_action}"/>
        <input class="underlined" name="attr_assault_level" type="number" title="@{assault_level}"/>
        <input class="underlined" name="attr_assault_experience" type="number" title="@{assault_experience}"/>
        <button class="roller" name="roll_strike_roll" data-i18n="strike" role="heading" aria-level="4" value="@{strike_action}" title="%{strike_roll}" type="roll">
        </button>
        <button name="act_strike-action" hidden="" type="action" title="%{strike-action}">
        </button>
        <input name="attr_strike_action" type="hidden" title="@{strike_action}"/>
        <input class="underlined" name="attr_strike_level" type="number" title="@{strike_level}"/>
        <input class="underlined" name="attr_strike_experience" type="number" title="@{strike_experience}"/>
        <button class="roller" name="roll_motion_roll" data-i18n="motion" role="heading" aria-level="4" value="@{motion_action}" title="%{motion_roll}" type="roll">
        </button>
        <button name="act_motion-action" hidden="" type="action" title="%{motion-action}">
        </button>
        <input name="attr_motion_action" type="hidden" title="@{motion_action}"/>
        <input class="underlined" name="attr_motion_level" type="number" title="@{motion_level}"/>
        <input class="underlined" name="attr_motion_experience" type="number" title="@{motion_experience}"/>
      </div>
    </section>
    <section class="stat-grid section" id="remnant-stats">
      <h2 data-i18n="remnant stats">
      </h2>
      <label class="span-2" data-i18n="armour" for="armour" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_armour" type="number" id="armour" title="@{armour}"/>
      <label class="span-2" data-i18n="speed" for="speed" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_speed" type="number" id="speed" title="@{speed}"/>
      <label class="span-2" data-i18n="inspiring" for="inspiring" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_inspiring" type="number" id="inspiring" title="@{inspiring}"/>
      <label class="span-2" data-i18n="terrifying" for="terrifying" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_terrifying" type="number" id="terrifying" title="@{terrifying}"/>
      <div class="input-label span-all structure">
        <label data-i18n="structure" for="structure" role="heading" aria-level="4"></label>
        <div class="boxed span-2">
          <input name="attr_structure" id="structure" type="number" title="@{structure}"/><span class="slash">/</span>
          <input name="attr_structure_max" value="5" type="hidden" title="@{structure|max}"/>
          <input name="attr_structure_base" value="5" type="number" title="@{structure_base}"/>
        </div>
      </div>
      <label class="assault_damage_label" data-i18n="assault damage" role="heading" aria-level="4" for="assault_damage"></label><!-- inputObj: {"name":"assault damage","class":"boxed assault_damage_input","type":"number","id":"assault_damage","trigger":{"affects":["repeating_remnant-weapon_$x_damage"]}}-->
      <input class="boxed assault_damage_input" name="attr_assault_damage" type="number" id="assault_damage" title="@{assault_damage}"/>
      <label class="strike_damage_label" data-i18n="strike damage" role="heading" aria-level="4" for="strike_damage"></label><!-- inputObj: {"name":"strike damage","class":"boxed strike_damage_input","type":"number","id":"strike_damage","trigger":{"affects":["repeating_remnant-weapon_$x_damage"]}}-->
      <input class="boxed strike_damage_input" name="attr_strike_damage" type="number" id="strike_damage" title="@{strike_damage}"/>
      <label class="strike_range_label" data-i18n="strike range" role="heading" aria-level="4" for="strike_range"></label><!-- inputObj: {"name":"strike range","class":"boxed strike_range_input","type":"number","id":"strike_range","trigger":{"calculation":"calcStrikeRange"}}-->
      <input class="boxed strike_range_input" name="attr_strike_range" type="number" id="strike_range" title="@{strike_range}"/>
    </section>
    <section class="repeating-container--specialty repeating-container section" id="remnant-specialty">
      <h2 data-i18n="specialty"></h2>
      <div class="repeat-columns">
        <h5 data-i18n="name"></h5>
      </div>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-specialty" type="action" title="%{add-specialty}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-specialty" type="action" title="%{edit-specialty}">
      </button>
      <fieldset class="repeating_specialty">
        <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_specialty_$X_collapse}"/>
        <input class="underlined" name="attr_name" type="text" title="@{repeating_specialty_$X_name}"/>
        <div class="headed-textarea description expanded">
          <h5 data-i18n="description">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_description" title="@{repeating_specialty_$X_description}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_description" title="@{repeating_specialty_$X_description}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
    <section class="repeating-container--trait repeating-container section" id="remnant-trait">
      <h2 data-i18n="traits"></h2>
      <div class="repeat-columns">
        <h5 data-i18n="name"></h5>
        <h5 data-i18n="duress"></h5>
        <h5 data-i18n="focus"></h5>
      </div>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-trait" type="action" title="%{add-trait}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-trait" type="action" title="%{edit-trait}">
      </button>
      <fieldset class="repeating_trait">
        <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_trait_$X_collapse}"/>
        <input class="underlined" name="attr_name" type="text" title="@{repeating_trait_$X_name}"/>
        <input class="underlined" name="attr_duress" type="number" title="@{repeating_trait_$X_duress}"/>
        <input class="underlined" name="attr_focus" type="number" title="@{repeating_trait_$X_focus}"/>
        <div class="headed-textarea description expanded">
          <h5 data-i18n="description">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_description" title="@{repeating_trait_$X_description}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_description" title="@{repeating_trait_$X_description}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
    <section class="repeating-container repeating-container--drone section" id="remnant-drone">
      <h2 data-i18n="drones">
      </h2>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-drone" type="action" title="%{add-drone}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-drone" type="action" title="%{edit-drone}">
      </button>
      <fieldset class="repeating_drone">
        <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_drone_$X_collapse}"/>
        <input class="underlined remnant-drone__name" name="attr_name" role="heading" aria-level="3" type="text" title="@{repeating_drone_$X_name}"/>
        <label class="input-label"><span class="input-label__text" data-i18n="# active" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_active" type="number" title="@{repeating_drone_$X_active}"/>
        </label>
        <label class="input-label sa"><span class="input-label__text" data-i18n="situation awareness abbreviation" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_sa" type="number" title="@{repeating_drone_$X_sa}"/>
        </label>
        <label class="input-label def"><span class="input-label__text" data-i18n="defence" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_def" type="number" title="@{repeating_drone_$X_def}"/>
        </label>
        <label class="input-label arm"><span class="input-label__text" data-i18n="armour" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_arm" type="number" title="@{repeating_drone_$X_arm}"/>
        </label>
        <label class="input-label spd"><span class="input-label__text" data-i18n="speed" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_spd" type="number" title="@{repeating_drone_$X_spd}"/>
        </label>
        <div class="structure"><span role="heading" aria-level="5" data-i18n="structure"></span>
          <div class="boxed span-2">
            <input name="attr_struct" type="number" title="@{repeating_drone_$X_struct}"/><span class="slash">/</span>
            <input name="attr_struct_max" type="number" title="@{repeating_drone_$X_struct|max}"/>
          </div>
        </div>
        <input class="underlined expanded--empty" name="attr_assault" type="hidden" title="@{repeating_drone_$X_assault}"/>
        <div class="input-label input-label--button assault">
          <button class="roller" name="roll_assault" role="heading" aria-level="5" data-i18n="assault" value="@{assault_action}" title="%{repeating_drone_$X_assault}" type="roll">
          </button>
          <input class="boxed input-label__input" name="attr_assault" type="number" title="@{repeating_drone_$X_assault}"/>
        </div>
        <button name="act_assault-action" hidden="" type="action" title="%{repeating_drone_$X_assault-action}">
        </button>
        <input name="attr_assault_action" type="hidden" title="@{repeating_drone_$X_assault_action}"/>
        <input class="underlined expanded--empty" name="attr_assault" type="hidden" title="@{repeating_drone_$X_assault}"/>
        <label class="input-label assault_dam"><span class="input-label__text" data-i18n="assault damage" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_assault_dam" type="number" title="@{repeating_drone_$X_assault_dam}"/>
        </label>
        <input class="underlined expanded--empty" name="attr_strike" type="hidden" title="@{repeating_drone_$X_strike}"/>
        <div class="input-label input-label--button strike">
          <button class="roller" name="roll_strike" role="heading" aria-level="5" data-i18n="strike" value="@{strike_action}" title="%{repeating_drone_$X_strike}" type="roll">
          </button>
          <input class="boxed input-label__input" name="attr_strike" type="number" title="@{repeating_drone_$X_strike}"/>
        </div>
        <button name="act_strike-action" hidden="" type="action" title="%{repeating_drone_$X_strike-action}">
        </button>
        <input name="attr_strike_action" type="hidden" title="@{repeating_drone_$X_strike_action}"/>
        <input class="underlined expanded--empty" name="attr_strike" type="hidden" title="@{repeating_drone_$X_strike}"/>
        <label class="input-label strike_dam"><span class="input-label__text" data-i18n="strike damage" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_strike_dam" type="number" title="@{repeating_drone_$X_strike_dam}"/>
        </label>
        <input class="underlined expanded--empty" name="attr_strike" type="hidden" title="@{repeating_drone_$X_strike}"/>
        <label class="input-label strikerange"><span class="input-label__text" data-i18n="strike range" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_strikerange" type="number" readonly="" title="@{repeating_drone_$X_strikerange}"/>
        </label>
        <div class="headed-textarea description expanded">
          <h5 data-i18n="description">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_description" title="@{repeating_drone_$X_description}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_description" title="@{repeating_drone_$X_description}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
    <section class="repeating-container repeating-container--remnant-weapons section" id="remnant-weapons">
      <h2 data-i18n="weapons">
      </h2>
      <div class="repeat-columns"> 
        <h5 data-i18n="name">
        </h5>
        <h5 data-i18n="skill">
        </h5>
        <h5 data-i18n="bonus">
        </h5>
        <h5 data-i18n="damage">
        </h5>
        <h5 data-i18n="damage bonus">
        </h5>
        <h5 data-i18n="type">
        </h5>
      </div>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-remnant-weapon" type="action" title="%{add-remnant-weapon}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-remnant-weapon" type="action" title="%{edit-remnant-weapon}">
      </button>
      <fieldset class="repeating_remnant-weapon">
        <input class="collapse" name="attr_collapse" type="checkbox" title="@{repeating_remnant-weapon_$X_collapse}"/>
        <button class="roller" name="roll_roll" value="@{action}" title="%{repeating_remnant-weapon_$X_roll}" type="roll">
        </button>
        <button name="act_action" hidden="" type="action" title="%{repeating_remnant-weapon_$X_action}">
        </button>
        <input name="attr_action" type="hidden" title="@{repeating_remnant-weapon_$X_action}"/>
        <input class="underlined" name="attr_name" role="heading" aria-level="4" type="text" title="@{repeating_remnant-weapon_$X_name}"/>
        <select class="underlined" name="attr_skill" title="@{repeating_remnant-weapon_$X_skill}">
          <option value=" " data-i18n="select" selected="">
          </option>
          <option value="assault" data-i18n="assault">
          </option>
          <option value="strike" data-i18n="strike">
          </option>
        </select>
        <input class="underlined" name="attr_bonus" type="number" title="@{repeating_remnant-weapon_$X_bonus}"/>
        <div class="roll-plus"><span data-i18n="lead"></span><span class="plus">+</span>
          <input class="underlined" name="attr_damage" readonly="" type="number" title="@{repeating_remnant-weapon_$X_damage}"/>
        </div>
        <input class="underlined damage-bonus" name="attr_damage_bonus" type="number" title="@{repeating_remnant-weapon_$X_damage_bonus}"/>
        <input class="underlined" name="attr_type" type="text" title="@{repeating_remnant-weapon_$X_type}"/>
        <div class="headed-textarea description expanded">
          <h5 data-i18n="notes">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_remnant-weapon_$X_notes}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_remnant-weapon_$X_notes}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
  </article>
  <article class="warbird subsystem-style navigable-section" id="warbird">
    <section class="section" id="warbird-pic">
      <div class="health-track">
        <h2 class="health-track__header" data-i18n="structure track">
        </h2>
        <input class="health-track__max-control" name="attr_structure_max" value="1" type="hidden" title="@{structure|max}"/>
        <fieldset class="repeating_structure">
          <input class="health-track__fill-control" name="attr_fill" hidden="" value="1" type="checkbox" title="@{repeating_structure_$X_fill}"/>
          <input class="health-track__clear-control health-track__checkbox" name="attr_damaged" value="1" type="checkbox" title="@{repeating_structure_$X_damaged}"/>
          <button class="health-track__clearer" name="act_clear" type="action" title="%{repeating_structure_$X_clear}">
          </button>
          <input class="boxed health-track__number" name="attr_penalty" type="number" title="@{repeating_structure_$X_penalty}"/>
        </fieldset>
      </div>
      <div class="image-container warbird-nose">
        <label class="input-label image-container__input stacked"><span class="input-label__text" data-i18n="image prompt" role="heading" aria-level="5"></span>
          <input class="boxed input-label__input" name="attr_warbird_nose" type="text" value="https://s3.amazonaws.com/files.d20.io/images/270598775/-4fyt16JZqo_JLLhKpGeCQ/original.jpg" title="@{warbird_nose}"/>
        </label>
        <button class="image-container__button" name="act_warbird-nose" type="action" title="%{warbird-nose}"><img class="image-container__image" name="attr_warbird_nose" src="https://s3.amazonaws.com/files.d20.io/images/270598775/-4fyt16JZqo_JLLhKpGeCQ/original.jpg" data-i18n-alt="warbird nose" title="@{warbird_nose}"/>
        </button>
      </div>
    </section>
    <section class="stat-grid section" id="warbird-ratings">
      <h2 data-i18n="total ratings">
      </h2>
      <button class="span-2 uppercase roller" name="roll_situational_awareness" role="heading" aria-level="4" data-i18n="situation awareness abbreviation" value="@{situational_awareness_action}" title="%{situational_awareness}" type="roll">
      </button>
      <button name="act_situational-awareness-action" hidden="" type="action" title="%{situational-awareness-action}">
      </button>
      <input name="attr_situational_awareness_action" type="hidden" title="@{situational_awareness_action}"/>
      <input class="boxed" name="attr_situational_awareness" readonly="" type="number" title="@{situational_awareness}"/>
      <input class="boxed" name="attr_situational_awareness_mod" type="number" title="@{situational_awareness_mod}"/>
      <button class="roller" name="roll_warbird_initiative" data-i18n="initiative" role="heading" aria-level="4" value="@{warbird_initiative_action}" title="%{warbird_initiative}" type="roll">
      </button>
      <button name="act_warbird-initiative-action" hidden="" type="action" title="%{warbird-initiative-action}">
      </button>
      <input name="attr_warbird_initiative_action" type="hidden" title="@{warbird_initiative_action}"/>
      <select class="underlined" name="attr_warbird_initiative_skill" title="@{warbird_initiative_skill}">
        <option value="ask" data-i18n="ask">
        </option>
        <option value="piloting" data-i18n="piloting" selected="">
        </option>
        <option value="strafing" data-i18n="strafing">
        </option>
        <option value="gunnery" data-i18n="gunnery">
        </option>
        <option value="ordinance" data-i18n="ordinance">
        </option>
      </select>
      <input class="boxed" name="attr_warbird_initiative" readonly="" type="number" title="@{warbird_initiative}"/>
      <input class="boxed" name="attr_warbird_initiative_mod" type="number" title="@{warbird_initiative_mod}"/>
      <div class="warbird-skills">
        <h2 data-i18n="skills">
        </h2>
        <div class="repeat-columns">
          <h5 data-i18n="skill">
          </h5>
          <h5 data-i18n="level">
          </h5>
          <h5 data-i18n="xp">
          </h5>
        </div>
        <button class="roller" name="roll_piloting_roll" data-i18n="piloting" role="heading" aria-level="4" value="@{piloting_action}" title="%{piloting_roll}" type="roll">
        </button>
        <button name="act_piloting-action" hidden="" type="action" title="%{piloting-action}">
        </button>
        <input name="attr_piloting_action" type="hidden" title="@{piloting_action}"/>
        <input class="underlined" name="attr_piloting_level" type="number" title="@{piloting_level}"/>
        <input class="underlined" name="attr_piloting_experience" type="number" title="@{piloting_experience}"/>
        <button class="roller" name="roll_strafing_roll" data-i18n="strafing" role="heading" aria-level="4" value="@{strafing_action}" title="%{strafing_roll}" type="roll">
        </button>
        <button name="act_strafing-action" hidden="" type="action" title="%{strafing-action}">
        </button>
        <input name="attr_strafing_action" type="hidden" title="@{strafing_action}"/>
        <input class="underlined" name="attr_strafing_level" type="number" title="@{strafing_level}"/>
        <input class="underlined" name="attr_strafing_experience" type="number" title="@{strafing_experience}"/>
        <button class="roller" name="roll_gunnery_roll" data-i18n="gunnery" role="heading" aria-level="4" value="@{gunnery_action}" title="%{gunnery_roll}" type="roll">
        </button>
        <button name="act_gunnery-action" hidden="" type="action" title="%{gunnery-action}">
        </button>
        <input name="attr_gunnery_action" type="hidden" title="@{gunnery_action}"/>
        <input class="underlined" name="attr_gunnery_level" type="number" title="@{gunnery_level}"/>
        <input class="underlined" name="attr_gunnery_experience" type="number" title="@{gunnery_experience}"/>
        <button class="roller" name="roll_ordinance_roll" data-i18n="ordinance" role="heading" aria-level="4" value="@{ordinance_action}" title="%{ordinance_roll}" type="roll">
        </button>
        <button name="act_ordinance-action" hidden="" type="action" title="%{ordinance-action}">
        </button>
        <input name="attr_ordinance_action" type="hidden" title="@{ordinance_action}"/>
        <input class="underlined" name="attr_ordinance_level" type="number" title="@{ordinance_level}"/>
        <input class="underlined" name="attr_ordinance_experience" type="number" title="@{ordinance_experience}"/>
      </div>
    </section>
    <section class="stat-grid section" id="warbird-stats">
      <h2 data-i18n="warbird stats">
      </h2>
      <label data-i18n="performance" for="performance" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_performance" readonly="" id="performance" type="number" title="@{performance}"/>
      <input class="boxed" name="attr_performance_bonus" type="number" title="@{performance_bonus}"/>
      <label data-i18n="armour" for="armour" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_armour" readonly="" id="armour" type="number" title="@{armour}"/>
      <input class="boxed" name="attr_armour_bonus" type="number" title="@{armour_bonus}"/>
      <h3 class="span-all center" data-i18n="defences"></h3>
      <label data-i18n="break defence" for="break_defence" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_break_defence" readonly="" id="break_defence" type="number" title="@{break_defence}"/>
      <input class="boxed" name="attr_break_defence_bonus" type="number" title="@{break_defence_bonus}"/>
      <label data-i18n="shoot defence" for="shoot_defence" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_shoot_defence" readonly="" id="shoot_defence" type="number" title="@{shoot_defence}"/>
      <input class="boxed" name="attr_shoot_defence_bonus" type="number" title="@{shoot_defence_bonus}"/>
      <label data-i18n="escape defence" for="escape_defence" role="heading" aria-level="4"></label>
      <input class="boxed" name="attr_escape_defence" readonly="" id="escape_defence" type="number" title="@{escape_defence}"/>
      <input class="boxed" name="attr_escape_defence_bonus" type="number" title="@{escape_defence_bonus}"/>
      <button class="roller" name="roll_stunt" data-i18n="stunt" role="heading" aria-level="4" value="@{stunt_action}" title="%{stunt}" type="roll">
      </button>
      <button name="act_stunt-action" hidden="" type="action" title="%{stunt-action}">
      </button>
      <input name="attr_stunt_action" type="hidden" title="@{stunt_action}"/>
      <input class="boxed" name="attr_stunt" readonly="" id="stunt" type="number" title="@{stunt}"/>
      <input class="boxed" name="attr_stunt_bonus" type="number" title="@{stunt_bonus}"/>
      <div class="input-label span-all structure">
        <label data-i18n="structure" for="structure" role="heading" aria-level="4"></label>
        <div class="boxed span-2">
          <input name="attr_structure" id="structure" type="number" title="@{structure}"/><span class="slash">/</span>
          <input name="attr_structure_max" value="5" type="hidden" title="@{structure|max}"/>
          <input name="attr_structure_base" value="5" type="number" title="@{structure_base}"/>
        </div>
      </div>
    </section>
    <section class="repeating-container--trait repeating-container section" id="warbird-trait">
      <h2 data-i18n="warbird traits"></h2>
      <div class="repeat-columns">
        <h5 data-i18n="name"></h5>
        <h5 data-i18n="effects"></h5>
      </div>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-trait" type="action" title="%{add-trait}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-trait" type="action" title="%{edit-trait}">
      </button>
      <fieldset class="repeating_trait">
        <input class="collapse" name="attr_collapse" value="1" type="checkbox" title="@{repeating_trait_$X_collapse}"/>
        <input class="underlined" name="attr_name" type="text" title="@{repeating_trait_$X_name}"/>
        <input class="underlined" name="attr_effects" type="text" title="@{repeating_trait_$X_effects}"/>
        <div class="headed-textarea description expanded">
          <h5 data-i18n="description">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_description" title="@{repeating_trait_$X_description}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_description" title="@{repeating_trait_$X_description}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
    <section class="repeating-container repeating-container--warbird-weapons section" id="warbird-weapons">
      <h2 data-i18n="weapons">
      </h2>
      <button class="repcontrol-button repcontrol-button--add" name="act_add-warbird-weapon" type="action" title="%{add-warbird-weapon}">
      </button>
      <button class="repcontrol-button repcontrol-button--edit" name="act_edit-warbird-weapon" type="action" title="%{edit-warbird-weapon}">
      </button>
      <fieldset class="repeating_warbird-weapon">
        <input class="collapse" name="attr_collapse" value="1" type="checkbox" title="@{repeating_warbird-weapon_$X_collapse}"/>
        <button class="roller" name="roll_roll" value="@{action}" title="%{repeating_warbird-weapon_$X_roll}" type="roll">
        </button>
        <button name="act_action" hidden="" type="action" title="%{repeating_warbird-weapon_$X_action}">
        </button>
        <input name="attr_action" type="hidden" title="@{repeating_warbird-weapon_$X_action}"/>
        <label class="input-label type"><span class="input-label__text" data-i18n="type" role="heading" aria-level="5"></span>
          <input class="underlined input-label__input" name="attr_name" value="" type="text" role="heading" aria-level="4" title="@{repeating_warbird-weapon_$X_name}"/>
        </label>
        <label class="input-label"><span class="input-label__text" data-i18n="skill" role="heading" aria-level="5"></span>
          <select class="underlined skill input-label__input" name="attr_skill" title="@{repeating_warbird-weapon_$X_skill}">
            <option value=" " data-i18n="select" selected="">
            </option>
            <option value="gunnery" data-i18n="gunnery">
            </option>
            <option value="ordinance" data-i18n="ordinance">
            </option>
          </select>
        </label>
        <div class="input-label input-label--dual accuracy"><span data-i18n="accuracy" role="heading" aria-level="5"></span>
          <input class="underlined" name="attr_accuracy" type="number" title="@{repeating_warbird-weapon_$X_accuracy}"/><span class="input-label--dual__spacer">+</span>
          <input class="underlined" name="attr_accuracy_bonus" type="number" title="@{repeating_warbird-weapon_$X_accuracy_bonus}"/>
        </div>
        <div class="input-label input-label--dual">
          <div class="roll-plus"><span data-i18n="lead"></span><span class="plus">+</span>
            <input class="underlined input-label__input" name="attr_damage" type="number" title="@{repeating_warbird-weapon_$X_damage}"/>
          </div><span class="input-label--dual__spacer"/>
          <input class="underlined" name="attr_damage_bonus" type="number" title="@{repeating_warbird-weapon_$X_damage_bonus}"/>
        </div>
        <div class="input-label ammo">
          <h5 data-i18n="ammunition"></h5>
          <input class="ammo-display-control" name="attr_skill" value="ordinance" hidden="" type="checkbox" title="@{repeating_warbird-weapon_$X_skill}"/>
          <div class="ammo-tracker fill-left">
            <input class="fill-left__clearer fill-left__dot" name="attr_ammo" value="0" checked="" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="1" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="2" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="3" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="4" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="5" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="6" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="7" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="8" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="9" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="10" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="11" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="12" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="13" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="14" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="15" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="16" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="17" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="18" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="19" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
            <input class="fill-left__dot fill-left__radio" name="attr_ammo" value="20" type="radio" title="@{repeating_warbird-weapon_$X_ammo}"/>
          </div>
        </div>
        <div class="headed-textarea description expanded">
          <h5 data-i18n="notes">
          </h5>
          <div class="adaptive adaptive--text"><span class="adaptive--text__span" name="attr_notes" title="@{repeating_warbird-weapon_$X_notes}"></span>
            <textarea class="underlined adaptive--text__textarea" name="attr_notes" title="@{repeating_warbird-weapon_$X_notes}"></textarea>
          </div>
        </div>
      </fieldset>
    </section>
  </article>
  <rolltemplate class="sheet-rolltemplate-rapidfire">
    <div class="template undefined system-{{system}}">
      <div class="content {{#singleroll}}single-roll{{/singleroll}}">{{#header}}
        <div class="header">
          <div class="header__background background">
            <h3 tabindex="-1">{{header}}</h3>
          </div>
          <div class="header__content">
            <h3>{{header}}</h3>
          </div>
          <div class="header__image"></div>
        </div>{{/header}}{{#roll}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status -2}}{{#rollGreater() computed::status 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll}}
              </div>
            </div>
          </div>
        </div>{{/roll}}{{#roll1}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status1 -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status1 -2}}{{#rollGreater() computed::status1 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status1 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll1}}
              </div>
            </div>
          </div>
        </div>{{/roll1}}{{#roll2}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status2 -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status2 -2}}{{#rollGreater() computed::status2 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status2 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll2}}
              </div>
            </div>
          </div>
        </div>{{/roll2}}{{#roll3}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status3 -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status3 -2}}{{#rollGreater() computed::status3 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status3 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll3}}
              </div>
            </div>
          </div>
        </div>{{/roll3}}{{#roll4}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status4 -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status4 -2}}{{#rollGreater() computed::status4 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status4 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll4}}
              </div>
            </div>
          </div>
        </div>{{/roll4}}{{#roll5}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status5 -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status5 -2}}{{#rollGreater() computed::status5 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status5 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll5}}
              </div>
            </div>
          </div>
        </div>{{/roll5}}{{#roll6}}
        <div class="hexagon sheet-roll">{{#rollLess() computed::status6 -2}}<span class="fumble-toggle" hidden=""></span>{{/rollLess() computed::status6 -2}}{{#rollGreater() computed::status6 4}}<span class="crit-toggle" hidden=""></span>{{/rollGreater() computed::status6 4}}
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="roll"></h4>{{roll6}}
              </div>
            </div>
          </div>
        </div>{{/roll6}}{{#difficulty}}
        <div class="hexagon difficulty">
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">
                <h4 data-i18n="difficulty"></h4>{{difficulty}}
              </div>
            </div>
          </div>
        </div>{{/difficulty}}{{#damage}}
        <div class="hexagon damage">
          <div class="hexagon__hex-wrapper">
            <div class="hexagon__hex-wrapper__hex-border">
              <div class="hexagon__hex-wrapper__hex-border__hex-content">{{#damage_label}}
                <h4>{{computed::damage_label}}</h4>{{/damage_label}}{{^damage_label}}
                <h4 data-i18n="damage"></h4>{{/damage_label}}{{computed::damage}}
              </div>
            </div>
          </div>
        </div>{{/damage}}{{#description}}
        <div class="container-background description"></div>
        <div class="description text">
          <h4 data-i18n="notes"></h4><span>{{description}}</span>{{#allprops() description damage difficulty roll roll1 roll2 roll3 roll4 roll5 roll6 header footer character_id system single-roll custom_description status}}
          <h4>{{key}}</h4><span>{{value}}</span>{{/allprops() description damage difficulty roll roll1 roll2 roll3 roll4 roll5 roll6 header footer character_id system single-roll custom_description status}}
        </div>{{/description}}{{^description}}{{#custom_description}}
        <div class="container-background description"></div>
        <div class="description text">{{#allprops() description damage difficulty roll roll1 roll2 roll3 roll4 roll5 roll6 header footer character_id system single-roll custom_description status}}
          <h4>{{key}}</h4><span>{{value}}</span>{{/allprops() description damage difficulty roll roll1 roll2 roll3 roll4 roll5 roll6 header footer character_id system single-roll custom_description status}}
        </div>{{/custom_description}}{{/description}}{{#character_name}}
        <div class="footer">
          <div class="footer__background background">{{#character_id}}
            <h4 class="character_name" tabindex="-1">[{{character_name}}](http://journal.roll20.net/character/{{character_id}})</h4>{{/character_id}}{{^character_id}}
            <h4 class="character_name" tabindex="-1">{{character_name}}</h4>{{/character_id}}
          </div>
          <div class="footer__content">{{#character_id}}
            <h4 class="character_name">[{{character_name}}](http://journal.roll20.net/character/{{character_id}})</h4>{{/character_id}}{{^character_id}}
            <h4 class="character_name">{{character_name}}</h4>{{/character_id}}
          </div>
          <div class="footer__image"></div>
        </div>{{/character_name}}
      </div>
    </div>
    <div class="image-border{{#header}} has-header{{/header}}{{#character_name}} has-footer{{/character_name}}"></div>
  </rolltemplate>
</main>
<script type="text/worker">
  const k = (function(){const kFuncs = {};
/**
 * This stores the name of your sheet for use in the logging functions {@link log} and {@link debug}
 * * @var
 * @type {string}
 */
let sheetName = 'kScaffold Powered Sheet';
kFuncs.sheetName = sheetName;
/**
	* This stores the version of your sheet for use in the logging functions{@link log} and {@link debug}. It is also stored in the sheet_version attribute on your character sheet.
	* @var
	* @type {number}
	*/
let version = 0;
kFuncs.version = version;
/**
	* A boolean flag that tells the script whether to enable or disable {@link debug} calls. If the version of the sheet is `0`, or an attribute named `debug_mode` is found on opening this is set to true for your entire session. Otherwise, it remains false.
	* @var
	* @type {boolean}
	*/
let debugMode = false;
kFuncs.debugMode = debugMode;/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
/**
 * Replaces problem characters to use a string as a regex.
 * @param {string} text
 * @returns {string}
 */
const sanitizeForRegex = function(text){
  return text.replace(/\.|\||\(|\)|\[|\]|\-|\+|\?|\/|\{|\}|\^|\$|\*/g,'\\$&');
};
kFuncs.sanitizeForRegex = sanitizeForRegex;
//
/**
 * Converts a value to a number, it's default value, or 0.
 * @param {*} val
 * @param {number} def
 * @returns {number}
 */
const value = function(val,def){
  return (+val||def||0);
};
kFuncs.value = value;

/*
e.g. repeating_equipment_-09Jhu89z_bulk would give:
section: equipment
rowID: -09Jhu89z
field: bulk
*/
/**
 * Extracts the section (e.g. `repeating_equipment`), rowID (e.g `-;lkj098J:LKj`), and field name (e.g. `bulk`) from a repeating attribute name.
 * @param {string} string
 * @returns {string[]}
 */
const parseRepeatName = function(string){
  let match = string.match(/(repeating_[^_]+)_([^_]+)(?:_(.+))?/);
  match.shift();
  return match;
};
kFuncs.parseRepeatName = parseRepeatName;

/**
 * Parses out the components of a trigger name similar to {@link parseRepeatName}. Aliases: parseClickTrigger.
 * @param {string} string
 * @returns {string[]}
 */
const parseTriggerName = function(string){
  let match = string.replace(/^clicked:/,'').match(/(?:(repeating_[^_]+)_([^_]+)_)?(.+)/);
  match.shift();
  return match;
};
kFuncs.parseTriggerName = parseTriggerName;
const parseClickTrigger = parseTriggerName;

kFuncs.parseClickTrigger = parseClickTrigger;
/**
 * Parses out the attribute name from the htmlattribute name.
 * @param {string} string
 * @returns {string[]}
 */
const parseHTMLName = function(string){
  let match = string.match(/(?:attr|act|roll)_(.+)/);
  match.shift();
  return match[0];
};
kFuncs.parseHTMLName = parseHTMLName;

/**
 * Capitalize each word in a string.
 * @param {string} string
 * @returns {string}
 */
const capitalize = function(string){
  return string.replace(/(?:^|\s+|\/)[a-z]/ig,(letter)=>letter.toUpperCase());
};
kFuncs.capitalize = capitalize;

/**
 * Extracts a roll query result for use in later functions. Must be awaited as per [startRoll documentation](https://wiki.roll20.net/Sheet_Worker_Scripts#Roll_Parsing.28NEW.29).
 * @param {string} query - The query should be just the text as the `?{` and `}` at the start/end of the query are added by the function.
 * @returns {string}
 */
const extractQueryResult = async function(query){
	debug('entering extractQueryResult');
	let queryRoll = await startRoll(`!{{query=[[0[response=?{${query}}]]]}}`);
	finishRoll(queryRoll.rollId);
	return queryRoll.results.query.expression.replace(/^.+?response=|\]$/g,'');
};
kFuncs.extractQueryResult = extractQueryResult;

/**
 * Simulates a query for ensuring that async/await works correctly in the sheetworker environment when doing conditional startRolls. E.g. if you have an if/else and only one of the conditions results in `startRoll` being called (and thus an `await`), the sheetworker environment would normally crash. Awaiting this in the condition that does not actually need to call `startRoll` will keep the environment in sync.
 * @param {string|number|undefined|null} value
 * @returns {string}
 */
const pseudoQuery = async function(value){
	debug('entering pseudoQuery');
	let queryRoll = await startRoll(`!{{query=[[0[response=${value}]]]}}`);
	finishRoll(queryRoll.rollId);
	return queryRoll.results.query.expression.replace(/^.+?response=|\]$/g,'');
};
kFuncs.pseudoQuery = pseudoQuery;

//# Utility Functions #
/**
 * An alias for console.log.
 * @param {string|object|Array} msg - The message can be  straight string or an object. If it is an object, the object will be broken down so that each key is used as a label to output followed by the value of that key. If the value of the key is an object or array, it will be output via console.table.
 * @returns {void}
 */
const log = function(msg){
  if(typeof msg === 'string'){
    console.log(`%c${kFuncs.sheetName} log| ${msg}`,"background-color:#159ccf");
  }else if(typeof msg === 'object'){
    Object.keys(msg).forEach((m)=>{
      if(typeof msg[m] === 'string'){
        console.log(`%c${kFuncs.sheetName} log| ${m}: ${msg[m]}`,"background-color:#159ccf");
      }else{
        console.log(`%c${kFuncs.sheetName} log| ${typeof msg[m]} ${m}`,"background-color:#159ccf");
        console.table(msg[m]);
      }
    });
  }
};
kFuncs.log = log;
/**
 * Alias for console.log that only triggers when debug mode is enabled or when the sheet's version is `0`.
 * @param {string|object|Array} msg - See {@link log}.
 * @param {boolean|string|number} [force=false] - Pass as a truthy value to force the debug output to be output to the console regardless of debug mode.
 * @returns {void}
 */
const debug = function(msg,force){
  if(!kFuncs.debugMode && !force && kFuncs.version > 0) return;
  if(typeof msg === 'string'){
    console.log(`%c${kFuncs.sheetName} DEBUG| ${msg}`,"background-color:tan;color:red;");
  }else if(typeof msg === 'object'){
    Object.keys(msg).forEach((m)=>{
      if(typeof msg[m] === 'string'){
        console.log(`%c${kFuncs.sheetName} DEBUG| ${m}: ${msg[m]}`,"background-color:tan;color:red;");
      }else{
        console.log(`%c${kFuncs.sheetName} DEBUG| ${typeof msg[m]} ${m}`,"background-color:tan;color:red;font-weight:bold;");
        console.table(msg[m]);
      }
    });
  }
};
kFuncs.debug = debug;

//Section ordering
//orders the section id arrays to match the repOrder attribute
/**
 * Orders the section id arrays to match the repOrder attribute.
 * @param {attributesProxy} attributes - An instance of the {@link attributesProxy}.
 * @param {sectionObj} sections - Array of details about a section to get the IDs for and attributes that need to be gotten.
 * @returns {void}
 */
const orderSections = function(attributes,sections){
  Object.keys(sections).forEach((section)=>{
    attributes.attributes[`_reporder_${section}`] = commaArray(attributes[`_reporder_${section}`]);
    orderSection(attributes.attributes[`_reporder_${section}`],sections[section]);
  });
};
kFuncs.orderSections = orderSections;

//
/**
 * Orders a single ID array
 * @param {string[]} repOrder - Array of IDs in the order they are in on the sheet.
 * @param {string[]} IDs - Array of IDs to be ordered
 * @returns {void}
 */
const orderSection = function(repOrder,IDs=[]){
  IDs.sort((a,b)=>{
    return repOrder.indexOf(a.toLowerCase()) - repOrder.indexOf(b.toLowerCase());
  });
};
kFuncs.orderSection = orderSection;

/**
 * Splits a comma delimited string into an array
 * @param {string} [string='']
 * @returns {string[]}
 */
const commaArray = function(string=''){
  return string.toLowerCase().split(/\s*,\s*/);
};
kFuncs.commaArray = commaArray;
  
  const cascades = {"attr_template_start":{"name":"template_start","type":"hidden","defaultValue":"&{template:rapidfire} {{character_name=@{character_name}}} {{character_id=@{character_id}}} {{system=@{system}}}","triggeredFuncs":[],"affects":[]},"attr_collapsed":{"name":"collapsed","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_system":{"name":"system","type":"hidden","defaultValue":"remnants","triggeredFuncs":[],"affects":[]},"attr_sheet_state":{"name":"sheet_state","type":"hidden","defaultValue":"settings","triggeredFuncs":[],"affects":[]},"attr_system_header":{"name":"system_header","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_nav-character":{"listenerFunc":"navigateSheet","name":"nav-character","listener":"clicked:nav-character","type":"action"},"act_nav-npc":{"listenerFunc":"navigateSheet","name":"nav-npc","listener":"clicked:nav-npc","type":"action"},"act_nav-settings":{"listenerFunc":"navigateSheet","name":"nav-settings","listener":"clicked:nav-settings","type":"action"},"act_nav-battle-remnant":{"listenerFunc":"navigateSheet","name":"nav-battle-remnant","listener":"clicked:nav-battle-remnant","type":"action"},"attr_difficulty":{"name":"difficulty","type":"checkbox","defaultValue":"1","triggeredFuncs":[],"affects":[]},"attr_action_penalty_automation":{"name":"action_penalty_automation","type":"select","defaultValue":"disabled","triggeredFuncs":[],"affects":[]},"attr_sheet_type":{"triggeredFuncs":["displayCharacterTypeSections"],"name":"sheet_type","listener":"change:sheet_type","listenerFunc":"accessSheet","type":"select","defaultValue":"character","affects":[]},"attr_whisper":{"name":"whisper","type":"select","defaultValue":" ","triggeredFuncs":[],"affects":[]},"attr_character_name":{"listener":true,"triggeredFuncs":["setActionCalls"],"name":"character_name","listenerFunc":"accessSheet","type":"text","defaultValue":"","affects":[]},"attr_player_name":{"name":"player_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_nationality":{"name":"nationality","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_organization_affiliations":{"name":"organization_affiliations","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_appearance/mannerisms":{"name":"appearance/mannerisms","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_health_max":{"name":"health_max","type":"hidden","defaultValue":"1","triggeredFuncs":["calcHealth"],"affects":["defence"],"listener":"change:health_max","listenerFunc":"accessSheet"},"attr_repeating_health_$X_fill":{"name":"repeating_health_$X_fill","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_health_$X_damaged":{"affects":["health"],"triggeredFuncs":["checkHealth"],"name":"repeating_health_$X_damaged","listener":"change:repeating_health:damaged","listenerFunc":"accessSheet","type":"checkbox","defaultValue":0},"act_repeating_health_$X_clear":{"listenerFunc":"clearTracker","name":"repeating_health_$X_clear","listener":"clicked:repeating_health:clear","type":"action"},"attr_repeating_health_$X_penalty":{"affects":["defence"],"name":"repeating_health_$X_penalty","listener":"change:repeating_health:penalty","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_stat_points":{"name":"stat_points","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_reserve":{"name":"reserve","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_body-action":{"listenerFunc":"initiateRoll","name":"body-action","listener":"clicked:body-action","type":"action"},"attr_body_action":{"name":"body_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_body":{"name":"body","type":"select","defaultValue":3,"triggeredFuncs":[],"affects":["defence","health_max","situational_awareness"],"listener":"change:body","listenerFunc":"accessSheet"},"attr_body_mod":{"affects":["defence","health_max","situational_awareness"],"name":"body_mod","listener":"change:body_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"act_mind-action":{"listenerFunc":"initiateRoll","name":"mind-action","listener":"clicked:mind-action","type":"action"},"attr_mind_action":{"name":"mind_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_mind":{"name":"mind","type":"select","defaultValue":3,"triggeredFuncs":[],"affects":["initiative","situational_awareness"],"listener":"change:mind","listenerFunc":"accessSheet"},"attr_mind_mod":{"affects":["initiative","situational_awareness"],"name":"mind_mod","listener":"change:mind_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"act_spirit-action":{"listenerFunc":"initiateRoll","name":"spirit-action","listener":"clicked:spirit-action","type":"action"},"attr_spirit_action":{"name":"spirit_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_spirit":{"name":"spirit","type":"select","defaultValue":3,"triggeredFuncs":[],"affects":["resist","health_max","situational_awareness"],"listener":"change:spirit","listenerFunc":"accessSheet"},"attr_spirit_mod":{"affects":["resist","health_max","situational_awareness"],"name":"spirit_mod","listener":"change:spirit_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_easy_living":{"name":"easy_living","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_fame":{"name":"fame","type":"number","defaultValue":2,"triggeredFuncs":[],"affects":[]},"attr_fame_points":{"name":"fame_points","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_add-equipment":{"listenerFunc":"addItem","name":"add-equipment","listener":"clicked:add-equipment","type":"action"},"act_edit-equipment":{"listenerFunc":"editSection","name":"edit-equipment","listener":"clicked:edit-equipment","type":"action"},"attr_repeating_equipment_$X_collapse":{"name":"repeating_equipment_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_equipment_$X_name":{"name":"repeating_equipment_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_equipment_$X_quantity":{"name":"repeating_equipment_$X_quantity","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_equipment_$X_notes":{"name":"repeating_equipment_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_initiative-action":{"listenerFunc":"initiateRoll","name":"initiative-action","listener":"clicked:initiative-action","type":"action"},"attr_initiative_action":{"name":"initiative_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_initiative":{"calculation":"calcInitiative","name":"initiative","type":"number","defaultValue":"0","triggeredFuncs":[],"affects":[]},"attr_initiative_mod":{"affects":["initiative"],"name":"initiative_mod","listener":"change:initiative_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_defence":{"calculation":"calcDefence","name":"defence","type":"number","defaultValue":3,"triggeredFuncs":[],"affects":[]},"attr_defence_mod":{"affects":["defence"],"name":"defence_mod","listener":"change:defence_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_resist":{"calculation":"calcResist","name":"resist","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_resist_mod":{"affects":["resist"],"name":"resist_mod","listener":"change:resist_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_health":{"affects":["defence"],"calculation":"totalHealth","initialFunc":"syncHealth","name":"health","listener":"change:health","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_health_mod":{"affects":["health_max"],"name":"health_mod","listener":"change:health_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_armour_bonus":{"affects":["resist","armour"],"name":"armour_bonus","listener":"change:armour_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_shield_bonus":{"affects":["defence"],"name":"shield_bonus","listener":"change:shield_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_action_penalty":{"triggeredFuncs":["validateActionPenalty"],"affects":["defence"],"name":"action_penalty","listener":"change:action_penalty","listenerFunc":"accessSheet","type":"number","defaultValue":0},"act_add-skill":{"listenerFunc":"addItem","name":"add-skill","listener":"clicked:add-skill","type":"action"},"act_edit-skill":{"listenerFunc":"editSection","name":"edit-skill","listener":"clicked:edit-skill","type":"action"},"attr_repeating_skill_$X_raw":{"name":"repeating_skill_$X_raw","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_skill_$X_name":{"name":"repeating_skill_$X_name","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_repeating_skill_$X_action":{"listenerFunc":"initiateRoll","name":"repeating_skill_$X_action","listener":"clicked:repeating_skill:action","type":"action"},"attr_repeating_skill_$X_action":{"name":"repeating_skill_$X_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_skill_$X_level":{"triggeredFuncs":["skillEffects"],"name":"repeating_skill_$X_level","listener":"change:repeating_skill:level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"affects":[]},"attr_repeating_skill_$X_stat":{"triggeredFuncs":["skillEffects"],"name":"repeating_skill_$X_stat","listener":"change:repeating_skill:stat","listenerFunc":"accessSheet","type":"select","defaultValue":"query","affects":[]},"attr_repeating_skill_$X_xp":{"name":"repeating_skill_$X_xp","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_add-advantage":{"listenerFunc":"addItem","name":"add-advantage","listener":"clicked:add-advantage","type":"action"},"act_edit-advantage":{"listenerFunc":"editSection","name":"edit-advantage","listener":"clicked:edit-advantage","type":"action"},"attr_repeating_advantage_$X_collapse":{"name":"repeating_advantage_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_advantage_$X_name":{"name":"repeating_advantage_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_advantage_$X_notes":{"name":"repeating_advantage_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-disadvantage":{"listenerFunc":"addItem","name":"add-disadvantage","listener":"clicked:add-disadvantage","type":"action"},"act_edit-disadvantage":{"listenerFunc":"editSection","name":"edit-disadvantage","listener":"clicked:edit-disadvantage","type":"action"},"attr_repeating_disadvantage_$X_collapse":{"name":"repeating_disadvantage_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_disadvantage_$X_name":{"name":"repeating_disadvantage_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_disadvantage_$X_notes":{"name":"repeating_disadvantage_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-adjustment":{"listenerFunc":"addItem","name":"add-adjustment","listener":"clicked:add-adjustment","type":"action"},"act_edit-adjustment":{"listenerFunc":"editSection","name":"edit-adjustment","listener":"clicked:edit-adjustment","type":"action"},"attr_repeating_adjustment_$X_collapse":{"name":"repeating_adjustment_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_adjustment_$X_name":{"name":"repeating_adjustment_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_adjustment_$X_notes":{"name":"repeating_adjustment_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-weapon":{"listenerFunc":"addItem","name":"add-weapon","listener":"clicked:add-weapon","type":"action"},"act_edit-weapon":{"listenerFunc":"editSection","name":"edit-weapon","listener":"clicked:edit-weapon","type":"action"},"attr_repeating_weapon_$X_collapse":{"name":"repeating_weapon_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_repeating_weapon_$X_action":{"listenerFunc":"initiateRoll","name":"repeating_weapon_$X_action","listener":"clicked:repeating_weapon:action","type":"action"},"attr_repeating_weapon_$X_action":{"name":"repeating_weapon_$X_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_weapon_$X_name":{"name":"repeating_weapon_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_weapon_$X_skill":{"name":"repeating_weapon_$X_skill","type":"hidden","defaultValue":"select","triggeredFuncs":[],"affects":[]},"act_repeating_weapon_$X_skill-action":{"listenerFunc":"dynamicSelect","name":"repeating_weapon_$X_skill-action","listener":"clicked:repeating_weapon:skill-action","type":"action"},"attr_repeating_weapon_$X_translate_skill":{"name":"repeating_weapon_$X_translate_skill","type":"checkbox","defaultValue":"1","triggeredFuncs":[],"affects":[]},"attr_repeating_weapon_$X_damage":{"name":"repeating_weapon_$X_damage","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_weapon_$X_notes":{"name":"repeating_weapon_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_remnant_structure_max":{"name":"remnant_structure_max","type":"hidden","defaultValue":"1","triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-structure_$X_fill":{"name":"repeating_remnant-structure_$X_fill","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-structure_$X_damaged":{"affects":["remnant_structure"],"triggeredFuncs":["checkHealth"],"name":"repeating_remnant-structure_$X_damaged","listener":"change:repeating_remnant-structure:damaged","listenerFunc":"accessSheet","type":"checkbox","defaultValue":0},"act_repeating_remnant-structure_$X_clear":{"listenerFunc":"clearTracker","name":"repeating_remnant-structure_$X_clear","listener":"clicked:repeating_remnant-structure:clear","type":"action"},"attr_repeating_remnant-structure_$X_penalty":{"affects":["remnant_defence"],"name":"repeating_remnant-structure_$X_penalty","listener":"change:repeating_remnant-structure:penalty","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_duress":{"name":"duress","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_remnant_token":{"triggeredFuncs":["imageInput"],"name":"remnant_token","listener":"change:remnant_token","listenerFunc":"accessSheet","type":"text","defaultValue":"https://s3.amazonaws.com/files.d20.io/images/259054779/OzN3yQwg7MbfXNtMYs-iOg/original.png","affects":[]},"act_remnant-token":{"listenerFunc":"toggleImageInput","name":"remnant-token","listener":"clicked:remnant-token","type":"action"},"act_situational-awareness-action":{"listenerFunc":"initiateRoll","name":"situational-awareness-action","listener":"clicked:situational-awareness-action","type":"action"},"attr_situational_awareness_action":{"name":"situational_awareness_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_situational_awareness":{"affects":["remnant_initiative","remnant_defence","warbird_initiative","warbird_defence"],"calculation":"calcSA","name":"situational_awareness","listener":"change:situational_awareness","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_situational_awareness_mod":{"affects":["situational_awareness"],"name":"situational_awareness_mod","listener":"change:situational_awareness_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_remnant_defence":{"affects":[],"calculation":"calcRemnantDefence","name":"remnant_defence","listener":"change:remnant_defence","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_remnant_defence_mod":{"affects":["remnant_defence"],"name":"remnant_defence_mod","listener":"change:remnant_defence_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"act_remnant-initiative-action":{"listenerFunc":"initiateRoll","name":"remnant-initiative-action","listener":"clicked:remnant-initiative-action","type":"action"},"attr_remnant_initiative_action":{"name":"remnant_initiative_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_remnant_initiative":{"calculation":"calcRemnantInitiative","name":"remnant_initiative","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_remnant_initiative_mod":{"affects":["remnant_initiative"],"name":"remnant_initiative_mod","listener":"change:remnant_initiative_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"act_assault-action":{"listenerFunc":"initiateRoll","name":"assault-action","listener":"clicked:assault-action","type":"action"},"attr_assault_action":{"name":"assault_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_assault_level":{"name":"assault_level","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_assault_experience":{"name":"assault_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_strike-action":{"listenerFunc":"initiateRoll","name":"strike-action","listener":"clicked:strike-action","type":"action"},"attr_strike_action":{"name":"strike_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_strike_level":{"affects":["strike_range"],"name":"strike_level","listener":"change:strike_level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_strike_experience":{"name":"strike_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_motion-action":{"listenerFunc":"initiateRoll","name":"motion-action","listener":"clicked:motion-action","type":"action"},"attr_motion_action":{"name":"motion_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_motion_level":{"affects":["remnant_defence"],"name":"motion_level","listener":"change:motion_level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_motion_experience":{"name":"motion_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_armour":{"name":"armour","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_speed":{"affects":["remnant_defence"],"name":"speed","listener":"change:speed","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_inspiring":{"name":"inspiring","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_terrifying":{"name":"terrifying","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_structure":{"affects":["remnant_defence"],"calculation":"totalHealth","initialFunc":"syncHealth","name":"structure","listener":"change:structure","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":["assignStructureEffects"]},"attr_structure_max":{"affects":["remnant_defence"],"triggeredFuncs":["calcHealth","assignStructureEffects"],"name":"structure_max","listener":"change:structure_max","listenerFunc":"accessSheet","type":"hidden","defaultValue":5},"attr_structure_base":{"affects":["structure_max"],"name":"structure_base","listener":"change:structure_base","listenerFunc":"accessSheet","type":"number","defaultValue":5,"triggeredFuncs":[]},"attr_assault_damage":{"affects":["repeating_remnant-weapon_$x_damage"],"name":"assault_damage","listener":"change:assault_damage","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_strike_damage":{"affects":["repeating_remnant-weapon_$x_damage"],"name":"strike_damage","listener":"change:strike_damage","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_strike_range":{"calculation":"calcStrikeRange","name":"strike_range","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_add-specialty":{"listenerFunc":"addItem","name":"add-specialty","listener":"clicked:add-specialty","type":"action"},"act_edit-specialty":{"listenerFunc":"editSection","name":"edit-specialty","listener":"clicked:edit-specialty","type":"action"},"attr_repeating_specialty_$X_collapse":{"name":"repeating_specialty_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_specialty_$X_name":{"name":"repeating_specialty_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_specialty_$X_description":{"name":"repeating_specialty_$X_description","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-trait":{"listenerFunc":"addItem","name":"add-trait","listener":"clicked:add-trait","type":"action"},"act_edit-trait":{"listenerFunc":"editSection","name":"edit-trait","listener":"clicked:edit-trait","type":"action"},"attr_repeating_trait_$X_collapse":{"name":"repeating_trait_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_trait_$X_name":{"name":"repeating_trait_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_trait_$X_duress":{"name":"repeating_trait_$X_duress","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_trait_$X_focus":{"name":"repeating_trait_$X_focus","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_trait_$X_description":{"name":"repeating_trait_$X_description","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-drone":{"listenerFunc":"addItem","name":"add-drone","listener":"clicked:add-drone","type":"action"},"act_edit-drone":{"listenerFunc":"editSection","name":"edit-drone","listener":"clicked:edit-drone","type":"action"},"attr_repeating_drone_$X_collapse":{"name":"repeating_drone_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_name":{"name":"repeating_drone_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_active":{"name":"repeating_drone_$X_active","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_sa":{"name":"repeating_drone_$X_sa","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_def":{"name":"repeating_drone_$X_def","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_arm":{"name":"repeating_drone_$X_arm","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_spd":{"name":"repeating_drone_$X_spd","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_struct":{"name":"repeating_drone_$X_struct","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_struct_max":{"name":"repeating_drone_$X_struct_max","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_assault":{"name":"repeating_drone_$X_assault","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_repeating_drone_$X_assault-action":{"listenerFunc":"initiateRoll","name":"repeating_drone_$X_assault-action","listener":"clicked:repeating_drone:assault-action","type":"action"},"attr_repeating_drone_$X_assault_action":{"name":"repeating_drone_$X_assault_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_assault_dam":{"name":"repeating_drone_$X_assault_dam","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_strike":{"name":"repeating_drone_$X_strike","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":["repeating_drone_$x_strikerange"],"listener":"change:repeating_drone:strike","listenerFunc":"accessSheet"},"act_repeating_drone_$X_strike-action":{"listenerFunc":"initiateRoll","name":"repeating_drone_$X_strike-action","listener":"clicked:repeating_drone:strike-action","type":"action"},"attr_repeating_drone_$X_strike_action":{"name":"repeating_drone_$X_strike_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_strike_dam":{"name":"repeating_drone_$X_strike_dam","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_strikerange":{"calculation":"calcStrikeRange","name":"repeating_drone_$X_strikerange","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_drone_$X_description":{"name":"repeating_drone_$X_description","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-remnant-weapon":{"listenerFunc":"addItem","name":"add-remnant-weapon","listener":"clicked:add-remnant-weapon","type":"action"},"act_edit-remnant-weapon":{"listenerFunc":"editSection","name":"edit-remnant-weapon","listener":"clicked:edit-remnant-weapon","type":"action"},"attr_repeating_remnant-weapon_$X_collapse":{"name":"repeating_remnant-weapon_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_repeating_remnant-weapon_$X_action":{"listenerFunc":"initiateRoll","name":"repeating_remnant-weapon_$X_action","listener":"clicked:repeating_remnant-weapon:action","type":"action"},"attr_repeating_remnant-weapon_$X_action":{"name":"repeating_remnant-weapon_$X_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-weapon_$X_name":{"name":"repeating_remnant-weapon_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-weapon_$X_skill":{"affects":["repeating_remnant-weapon_$x_damage"],"name":"repeating_remnant-weapon_$X_skill","listener":"change:repeating_remnant-weapon:skill","listenerFunc":"accessSheet","type":"select","defaultValue":" ","triggeredFuncs":[]},"attr_repeating_remnant-weapon_$X_bonus":{"name":"repeating_remnant-weapon_$X_bonus","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-weapon_$X_damage":{"calculation":"calcRemnantDamage","name":"repeating_remnant-weapon_$X_damage","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-weapon_$X_damage_bonus":{"affects":["repeating_remnant-weapon_$x_damage"],"name":"repeating_remnant-weapon_$X_damage_bonus","listener":"change:repeating_remnant-weapon:damage_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_repeating_remnant-weapon_$X_type":{"name":"repeating_remnant-weapon_$X_type","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_remnant-weapon_$X_notes":{"name":"repeating_remnant-weapon_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_structure_$X_fill":{"name":"repeating_structure_$X_fill","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_structure_$X_damaged":{"affects":["structure"],"triggeredFuncs":["checkHealth"],"name":"repeating_structure_$X_damaged","listener":"change:repeating_structure:damaged","listenerFunc":"accessSheet","type":"checkbox","defaultValue":0},"act_repeating_structure_$X_clear":{"listenerFunc":"clearTracker","name":"repeating_structure_$X_clear","listener":"clicked:repeating_structure:clear","type":"action"},"attr_repeating_structure_$X_penalty":{"affects":["break_defence"],"name":"repeating_structure_$X_penalty","listener":"change:repeating_structure:penalty","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_warbird_nose":{"triggeredFuncs":["imageInput"],"name":"warbird_nose","listener":"change:warbird_nose","listenerFunc":"accessSheet","type":"text","defaultValue":"https://s3.amazonaws.com/files.d20.io/images/270598775/-4fyt16JZqo_JLLhKpGeCQ/original.jpg","affects":[]},"act_warbird-nose":{"listenerFunc":"toggleImageInput","name":"warbird-nose","listener":"clicked:warbird-nose","type":"action"},"act_warbird-initiative-action":{"listenerFunc":"initiateRoll","name":"warbird-initiative-action","listener":"clicked:warbird-initiative-action","type":"action"},"attr_warbird_initiative_action":{"name":"warbird_initiative_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_warbird_initiative_skill":{"affects":["warbird_initiative"],"name":"warbird_initiative_skill","listener":"change:warbird_initiative_skill","listenerFunc":"accessSheet","type":"select","defaultValue":"ask","triggeredFuncs":[]},"attr_warbird_initiative":{"calculation":"calcWarbirdInitiative","name":"warbird_initiative","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_warbird_initiative_mod":{"affects":["warbird_initiative"],"name":"warbird_initiative_mod","listener":"change:warbird_initiative_mod","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"act_piloting-action":{"listenerFunc":"initiateRoll","name":"piloting-action","listener":"clicked:piloting-action","type":"action"},"attr_piloting_action":{"name":"piloting_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_piloting_level":{"affects":["dogfighting_rating","break_defence","stunt"],"name":"piloting_level","listener":"change:piloting_level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_piloting_experience":{"name":"piloting_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_strafing-action":{"listenerFunc":"initiateRoll","name":"strafing-action","listener":"clicked:strafing-action","type":"action"},"attr_strafing_action":{"name":"strafing_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_strafing_level":{"affects":["strafing_rating"],"name":"strafing_level","listener":"change:strafing_level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_strafing_experience":{"name":"strafing_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_gunnery-action":{"listenerFunc":"initiateRoll","name":"gunnery-action","listener":"clicked:gunnery-action","type":"action"},"attr_gunnery_action":{"name":"gunnery_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_gunnery_level":{"affects":["gunnery_rating"],"name":"gunnery_level","listener":"change:gunnery_level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_gunnery_experience":{"name":"gunnery_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_ordinance-action":{"listenerFunc":"initiateRoll","name":"ordinance-action","listener":"clicked:ordinance-action","type":"action"},"attr_ordinance_action":{"name":"ordinance_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_ordinance_level":{"affects":["ordinance_rating"],"name":"ordinance_level","listener":"change:ordinance_level","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_ordinance_experience":{"name":"ordinance_experience","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_performance":{"affects":["break_defence"],"name":"performance","listener":"change:performance","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_performance_bonus":{"affects":["performance"],"name":"performance_bonus","listener":"change:performance_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_break_defence":{"affects":["shoot_defence","escape_defence"],"calculation":"calcWarbirdDefence","name":"break_defence","listener":"change:break_defence","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_break_defence_bonus":{"affects":["break_defence"],"name":"break_defence_bonus","listener":"change:break_defence_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_shoot_defence":{"calculation":"calcWarbirdDefence","name":"shoot_defence","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_shoot_defence_bonus":{"affects":["shoot_defence"],"name":"shoot_defence_bonus","listener":"change:shoot_defence_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_escape_defence":{"calculation":"calcWarbirdDefence","name":"escape_defence","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_escape_defence_bonus":{"affects":["escape_defence"],"name":"escape_defence_bonus","listener":"change:escape_defence_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"act_stunt-action":{"listenerFunc":"initiateRoll","name":"stunt-action","listener":"clicked:stunt-action","type":"action"},"attr_stunt_action":{"name":"stunt_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_stunt":{"calculation":"calcWarbirdStunt","name":"stunt","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_stunt_bonus":{"affects":["stunt"],"name":"stunt_bonus","listener":"change:stunt_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_repeating_trait_$X_effects":{"name":"repeating_trait_$X_effects","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"act_add-warbird-weapon":{"listenerFunc":"addItem","name":"add-warbird-weapon","listener":"clicked:add-warbird-weapon","type":"action"},"act_edit-warbird-weapon":{"listenerFunc":"editSection","name":"edit-warbird-weapon","listener":"clicked:edit-warbird-weapon","type":"action"},"attr_repeating_warbird-weapon_$X_collapse":{"name":"repeating_warbird-weapon_$X_collapse","type":"checkbox","defaultValue":0,"triggeredFuncs":[],"affects":[]},"act_repeating_warbird-weapon_$X_action":{"listenerFunc":"initiateRoll","name":"repeating_warbird-weapon_$X_action","listener":"clicked:repeating_warbird-weapon:action","type":"action"},"attr_repeating_warbird-weapon_$X_action":{"name":"repeating_warbird-weapon_$X_action","type":"hidden","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_warbird-weapon_$X_name":{"name":"repeating_warbird-weapon_$X_name","type":"text","defaultValue":"","triggeredFuncs":[],"affects":[]},"attr_repeating_warbird-weapon_$X_skill":{"affects":["repeating_warbird-weapon_$x_damage"],"name":"repeating_warbird-weapon_$X_skill","listener":"change:repeating_warbird-weapon:skill","listenerFunc":"accessSheet","type":"select","defaultValue":" ","triggeredFuncs":[]},"attr_repeating_warbird-weapon_$X_accuracy":{"name":"repeating_warbird-weapon_$X_accuracy","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_warbird-weapon_$X_accuracy_bonus":{"name":"repeating_warbird-weapon_$X_accuracy_bonus","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_warbird-weapon_$X_damage":{"calculation":"calcVehicleDamage","name":"repeating_warbird-weapon_$X_damage","type":"number","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_warbird-weapon_$X_damage_bonus":{"affects":["repeating_warbird-weapon_$x_damage"],"name":"repeating_warbird-weapon_$X_damage_bonus","listener":"change:repeating_warbird-weapon:damage_bonus","listenerFunc":"accessSheet","type":"number","defaultValue":0,"triggeredFuncs":[]},"attr_repeating_warbird-weapon_$X_ammo":{"name":"repeating_warbird-weapon_$X_ammo","type":"radio","defaultValue":0,"triggeredFuncs":[],"affects":[]},"attr_repeating_warbird-weapon_$X_notes":{"name":"repeating_warbird-weapon_$X_notes","type":"span","defaultValue":"","triggeredFuncs":[],"affects":[]}};
  
  kFuncs.cascades = cascades;
  
  const repeatingSectionDetails = [{"section":"repeating_health","fields":["fill","damaged","penalty"]},{"section":"repeating_equipment","fields":["collapse","name","quantity","notes"]},{"section":"repeating_skill","fields":["raw","name","action","level","stat","xp"]},{"section":"repeating_advantage","fields":["collapse","name","notes"]},{"section":"repeating_disadvantage","fields":["collapse","name","notes"]},{"section":"repeating_adjustment","fields":["collapse","name","notes"]},{"section":"repeating_weapon","fields":["collapse","action","name","skill","translate_skill","damage","notes"]},{"section":"repeating_remnant-structure","fields":["fill","damaged","penalty"]},{"section":"repeating_specialty","fields":["collapse","name","description"]},{"section":"repeating_trait","fields":["collapse","name","duress","focus","description","effects"]},{"section":"repeating_drone","fields":["collapse","name","active","sa","def","arm","spd","struct","struct_max","assault","assault_action","assault_dam","strike","strike_action","strike_dam","strikerange","description"]},{"section":"repeating_remnant-weapon","fields":["collapse","action","name","skill","bonus","damage","damage_bonus","type","notes"]},{"section":"repeating_structure","fields":["fill","damaged","penalty"]},{"section":"repeating_warbird-weapon","fields":["collapse","action","name","skill","accuracy","accuracy_bonus","damage","damage_bonus","ammo","notes"]}];
  
  kFuncs.repeatingSectionDetails = repeatingSectionDetails;
  /*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//# Attribute Obj Proxy handler
const createAttrProxy = function(attrs){
  //creates a proxy for the attributes object so that values can be worked with more easily.
  const getCascObj = function(event,casc){
    let typePrefix = event.htmlAttributes ? 'act_' : 'attr_';
    let cascName = `${typePrefix}${event.sourceAttribute}`;
    let cascObj = casc[cascName];
    return cascObj;
  };
  
  const triggerFunctions = function(obj,attributes,sections){
    if(obj.triggeredFuncs && obj.triggeredFuncs.length){
      debug(`triggering functions for ${obj.name}`);
      obj.triggeredFuncs && obj.triggeredFuncs.forEach(func=>funcs[func] ? 
        funcs[func]({trigger:obj,attributes,sections}) :
        debug(`!!!Warning!!! no function named ${func} found. Triggered function not called for ${obj.name}`,true));
    }
  };
  
  const initialFunction = function(obj,attributes,sections){
    if(obj.initialFunc){
      debug(`initial functions for ${obj.name}`);
      funcs[obj.initialFunc] ?
        funcs[obj.initialFunc]({trigger:obj,attributes,sections}) :
        debug(`!!!Warning!!! no function named ${obj.initialFunc} found. Initial function not called for ${obj.name}`,true);
    }
  };
  const processChange = function({event,trigger,attributes,sections,casc}){
    debug({trigger});
    if(event && !trigger){
      debug('initial change detected. No trigger found');
      return;
    }
    if(!attributes || !sections || !casc){
      debug(`!!! Insufficient arguments || attributes > ${!!attributes} | sections > ${!!sections} | casc > ${!!casc} !!!`);
      return;
    }
    //store the queue in attributes.
    if(event){
      debug('checking for initial functions');
      initialFunction(trigger,attributes,sections);//functions that should only be run if the attribute was the thing changed by the user
    }
    if(trigger){
      debug(`processing ${trigger.name}`);
      triggerFunctions(trigger,attributes,sections);
      if(!event && trigger.calculation && funcs[trigger.calculation]){
        attributes[trigger.name] = funcs[trigger.calculation]({trigger,attributes,sections,casc});
      }else if(trigger.calculation && !funcs[trigger.calculation]){
        debug(`K-Scaffold Error: No function named ${trigger.calculation} found`);
      }
      if(Array.isArray(trigger.affects)){
        attributes.queue.push(...trigger.affects);
      }
    }
    attributes.set({attributes,sections,casc});
  };
  const attrTarget = {
    updates:{},
    attributes:{...attrs},
    repOrders:{},
    queue: [],
    casc:{},
    processChange,
    triggerFunctions,
    initialFunction,
    getCascObj
  };
  const attrHandler = {
    get:function(obj,prop){//gets the most value of the attribute.
      //If it is a repeating order, returns the array, otherwise returns the update value or the original value
      if(prop === 'set'){
        return function(){
          let {attributes,sections,casc,callback,vocal} = arguments[0] ? arguments[0] : {};
          if(attributes && attributes.queue.length && sections && casc){
            let triggerName = attributes.queue.shift();
            let trigger = getCascObj({sourceAttribute:triggerName},casc);
            attributes.processChange({trigger,attributes,sections,casc});
          }else{
            debug({updates:obj.updates});
            let trueCallback = Object.keys(obj.repOrders).length ?
              function(){
                Object.entries(obj.repOrders).forEach(([section,order])=>{
                  _setSectionOrder(section,order,)
                });
                callback && callback();
              }:
              callback;
            Object.keys(obj.updates).forEach((key)=>obj.attributes[key] = obj.updates[key]);
            const update = obj.updates;
            obj.updates = {};
            set(update,vocal,trueCallback);
          }
        }
      }else if(Object.keys(obj).some(key=>key===prop)){ 
        return Reflect.get(...arguments)
      }else{
        let retValue;
        switch(true){
          case obj.repOrders.hasOwnProperty(prop):
            retValue = obj.repOrders[prop];
            break;
          case obj.updates.hasOwnProperty(prop):
            retValue = obj.updates[prop];
            break;
          default:
            retValue = obj.attributes[prop];
            break;
        }
        let cascRef = `attr_${prop.replace(/(repeating_[^_]+_)[^_]+/,'$1\$X')}`;
        let numRetVal = +retValue;
        if(!Number.isNaN(numRetVal) && retValue !== ''){
          retValue = numRetVal;
        }else if(cascades[cascRef] && (typeof cascades[cascRef].defaultValue === 'number' || cascades[cascRef].type === 'number')){
          retValue = cascades[cascRef].defaultValue;
        }
        return retValue;
      }
    },
    set:function(obj,prop,value){
      //Sets the value. Also verifies that the value is a valid attribute value
      //e.g. not undefined, null, or NaN
      if(value || value===0 || value===''){
        if(/reporder|^repeating_[^_]+$/.test(prop)){
          let section = prop.replace(/_reporder_/,'');
          obj.repOrders[section] = value;
        }else if(`${obj.attributes}` !== `${value}` || 
          (obj.updates[prop] && `${obj.updates}` !== `${value}`)
        ){
          obj.updates[prop] = value;
        }
      }else{
        debug(`!!!Warning: Attempted to set ${prop} to an invalid value:${value}; value not stored!!!`);
      }
      return true;
    },
    deleteProperty(obj,prop){
      //removes the property from the original attributes, updates, and the reporders
      Object.keys(obj).forEach((key)=>{
        delete obj[key][prop.toLowerCase()];
      });
    }
  };
  return new Proxy(attrTarget,attrHandler);
};

const funcs = {};

/**
 * Function that registers a function for being called via the funcs object. Returns true if the function was successfully registered, and false if it could not be registered for any reason.
 * @param {object} funcObj - Object with keys that are names to register functions under and values that are functions.
 * @param {object} optionsObj - Object that contains options to use for this registration.
 * @param {string[]} optionsObj.type - Array that contains the types of specialized functions that apply to the functions being registered. Valid types are `"opener"`, `"updater"`, and `"default"`. `"default"` is always used, and never needs to be passed.
 * @returns {boolean} - True if the registration succeeded, false if it failed.
 */
const registerFuncs = function(funcObj,optionsObj = {}){
  if(typeof funcObj !== 'object' || typeof optionsObj !== 'object'){
    debug(`!!!! K-scaffold error: Improper arguments to register functions !!!!`);
    return false;
  }
  const typeArr = optionsObj.type ? ['default',...optionsObj.type] : ['default'];
  const typeSwitch = {
    'opener':openHandlers,
    'updater':updateHandlers,
    'new':initialSetupHandlers,
    'default':funcs
  };
  let setState;
  Object.entries(funcObj).map(([prop,value])=>{
    typeArr.forEach((type)=>{
      if(typeSwitch[type][prop]){
        debug(`!!! Duplicate function name for ${prop} as ${type}!!!`);
        setState = false;
      }else if(typeof value === 'function'){
        typeSwitch[type][prop] = value;
        setState = setState !== false ? true : false;
      }else{
        debug(`!!! K-scaffold error: Function registration requires a function. Invalid value to register as ${type} !!!`);
        setState = false;
      }
    });
  });
  return setState;
};
kFuncs.registerFuncs = registerFuncs;

/**
 * Function to call a function previously registered to the funcs object. May not be used that much. Either returns the function or null if no function exists.
 * @param {string} funcName - The name of the function to invoke.
 * @param {...any} args - The arguments to call the function with.
 * @returns {any}
 */
const callFunc = function(funcName,...args){
  if(funcs[funcName]){
    debug(`calling ${funcName}`);
    return funcs[funcName](...args);
  }else{
    debug(`Invalid function name: ${funcName}`);
    return null;
  }
};
kFuncs.callFunc = callFunc;/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Sheet Updaters and styling functions
/**
 * An object to store your update functions in. Functions should be index by the version they are for (e.g. the update handler for version 1.01 would be indexed to '1.01'). These update functions will be iterated through based on the previous version of the sheet (as stored in the `sheet_version` attribute of the sheet) and the new version of the sheet (as stored in {@link k.version}).
 * @type {object}
 */
const updateHandlers = {};
const openHandlers = {};
const initialSetupHandlers = {};
const updateSheet = function(){
  log('updating sheet');
  getAllAttrs({props:['sheet_version','debug_mode','collapsed',...baseGet],callback:(attributes,sections,casc)=>{
    kFuncs.debugMode = !!attributes.debug_mode;
    if(!attributes.sheet_version){
      Object.values(initialSetupHandlers).forEach((handler)=>{
        handler({attributes,sections,casc});
      });
    }else{
      Object.entries(updateHandlers).forEach(([ver,handler])=>{
        if(attributes.version < +ver){
          handler({attributes,sections,casc});
        }
      });
    }
    Object.entries(openHandlers).forEach(([funcName,func])=>{
      debug(`running ${funcName}`);
      func({attributes,sections,casc});
    });
    attributes.sheet_version = kFuncs.version;
    log(`Sheet Update applied. Current Sheet Version ${kFuncs.version}`);
    //styleOnOpen(attributes,sections);
    //setActionCalls({attributes,sections});
    attributes.set();
    log('Sheet ready for use');
  }});
};

const initialSetup = function(attributes,sections){
  debug('Initial sheet setup');
};

/**
 * This is the default listener function for attributes that the K-Scaffold uses. It utilizes the `triggerFuncs`, `listenerFunc`, `calculation`, and `affects` properties of the K-scaffold trigger object (see the Pug section of the scaffold for more details).
 * @param {Roll20Event} event
 * @returns {void}
 */
const accessSheet = function(event){
  debug({funcs:Object.keys(funcs)});
  debug({event});
  getAllAttrs({event,callback:(attributes,sections,casc)=>{
    let trigger = attributes.getCascObj(event,casc);
    attributes.processChange({event,trigger,attributes,sections,casc});
  }});
};
funcs.accessSheet = accessSheet;/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
/*
Cascade Expansion functions
*/
//Expands the repeating section templates in cascades to reflect the rows actually available
const expandCascade = function(cascade,sections,attributes){
  return _.keys(cascade).reduce((memo,key)=>{//iterate through cascades and replace references to repeating attributes with correct row ids.
    if(/^(?:act|attr)_repeating_/.test(key)){//If the attribute is a repeating attribute, do special logic
      expandRepeating(memo,key,cascade,sections,attributes);
    }else if(key){//for non repeating attributes do this logic
      expandNormal(memo,key,cascade,sections);
    }
    return memo;
  },{});
};

const expandRepeating = function(memo,key,cascade,sections,attributes){
  key.replace(/((?:attr|act)_)(repeating_[^_]+)_[^_]+?_(.+)/,(match,type,section,field)=>{
    (sections[section]||[]).forEach((id)=>{
      memo[`${type}${section}_${id}_${field}`]=_.clone(cascade[key]);//clone the details so that each row's attributes have correct ids
      memo[`${type}${section}_${id}_${field}`].name = `${section}_${id}_${field}`;
      if(key.startsWith('attr_')){
        memo[`${type}${section}_${id}_${field}`].affects = memo[`${type}${section}_${id}_${field}`].affects.reduce((m,affected)=>{
          if(section === affected){//otherwise if the affected attribute is in the same section, simply set the affected attribute to have the same row id.
            m.push(applyID(affected,id));
          }else if(/repeating/.test(affected)){//If the affected attribute isn't in the same repeating section but is still a repeating attribute, add all the rows of that section
            addAllRows(affected,m,sections);
          }else{//otherwise the affected attribute is a non repeating attribute. Simply add it to the computed affected array
            m.push(affected);
          }
          return m;
        },[]);
      }
    });
  });
};

const applyID = function(affected,id){
  return affected.replace(/(repeating_[^_]+_)[^_]+(.+)/,`$1${id}$2`);
};

const expandNormal = function(memo,key,cascade,sections){
  memo[key] = _.clone(cascade[key]);
  if(key.startsWith('attr_')){
    memo[key].affects = memo[key].affects.reduce((m,a)=>{
      if(/^repeating/.test(a)){
        addAllRows(a,m,sections);
      }else{
        m.push(a);
      }
      return m;
    },[]);
  }
};

const addAllRows = function(affected,memo,sections){
  affected.replace(/(repeating_[^_]+?)_[^_]+?_(.+)/,(match,section,field)=>{
    sections[section].forEach(id=>memo.push(`${section}_${id}_${field}`));
  });
};/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
/**
 * Alias for [setSectionOrder()](https://wiki.roll20.net/Sheet_Worker_Scripts#setSectionOrder.28.3CRepeating_Section_Name.3E.2C_.3CSection_Array.3E.2C_.3CCallback.3E.29) that allows you to use the section name in either `repeating_section` or `section` formats.
 * @name setSectionOrder
 * @param {string} section
 * @param {string[]} order
 * @returns {void}
 */
const _setSectionOrder = function(section,order){
  let trueSection = section.replace(/repeating_/,'');
  setSectionOrder(trueSection,order);
};
kFuncs.setSectionOrder = _setSectionOrder;

/**
 * Alias for [removeRepeatingRow](https://wiki.roll20.net/Sheet_Worker_Scripts#removeRepeatingRow.28_RowID_.29) that also removes the row from the current object of attribute values and array of section IDs to ensure that erroneous updates are not issued.
 * @name removeRepeatingRow
 * @param {string} row - The row id to be removed
 * @param {attributesProxy} attributes - The attribute values currently in memory
 * @param {object} sections - Object that contains arrays of all the IDs in sections on the sheet indexed by repeating name.
 * @returns {void}
 */
const _removeRepeatingRow = function(row,attributes,sections){
  debug(`removing ${row}`);
  Object.keys(attributes.attributes).forEach((key)=>{
    if(key.startsWith(row)){
      delete attributes[key];
    }
  });
  let [,section,rowID] = row.match(/(repeating_[^_]+)_(.+)/,'');
  sections[section] = sections[section].filter((id)=>id!==rowID);
  removeRepeatingRow(row);
};
kFuncs.removeRepeatingRow = _removeRepeatingRow;

/**
 * Alias for [getAttrs()](https://wiki.roll20.net/Sheet_Worker_Scripts#getAttrs.28attributeNameArray.2C_callback.29) that converts the default object of attribute values into an {@link attributesProxy} and passes that back to the callback function.
 * @name getAttrs
 * @param {Object} args
 * @param {string[]} [args.props=baseGet] - Array of attribute names to get the value of. Defaults to {@link baseGet} if not passed.
 * @param {function(attributesProxy)} args.callback - The function to call after the attribute values have been gotten. An {@link attributesProxy} is passed to the callback.
 */
const _getAttrs = function({props=baseGet,callback}){
  getAttrs(props,(values)=>{
    const attributes = createAttrProxy(values);
    callback(attributes);
  });
};
kFuncs.getAttrs = _getAttrs;

/**
 * Alias for [getAttrs()](https://wiki.roll20.net/Sheet_Worker_Scripts#getAttrs.28attributeNameArray.2C_callback.29) and [getSectionIDs](https://wiki.roll20.net/Sheet_Worker_Scripts#getSectionIDs.28section_name.2Ccallback.29) that combines the actions of both sheetworker functions and converts the default object of attribute values into an {@link attributesProxy}. Also gets the details on how to handle all attributes from the master {@link cascades} object and.
 * @param {Object} args
 * @param {string[]} [args.props=baseGet] - Array of attribute names to get the value of. Defaults to {@link baseGet} if not passed.
 * @param {repeatingSectionDetails} sectionDetails - Array of details about a section to get the IDs for and attributes that need to be gotten. 
 * @param {function(attributesProxy,sectionObj,expandedCascade):void} args.callback - The function to call after the attribute values have been gotten. An {@link attributesProxy} is passed to the callback along with a {@link sectionObj} and {@link expandedCascade}.
 */
const getAllAttrs = function({props=baseGet,sectionDetails=repeatingSectionDetails,callback}){
  getSections(sectionDetails,(repeats,sections)=>{
    getAttrs([...props,...repeats],(values)=>{
      const attributes = createAttrProxy(values);
      orderSections(attributes,sections);
      const casc = expandCascade(cascades,sections,attributes);
      callback(attributes,sections,casc);
    })
  });
};
kFuncs.getAllAttrs = getAllAttrs;

/**
 * Alias for [getSectionIDs()](https://wiki.roll20.net/Sheet_Worker_Scripts#getSectionIDs.28section_name.2Ccallback.29) that allows you to iterate through several functions at once. Also assembles an array of repeating attributes to get.
 * @param {object[]} sectionDetails - Array of details about a section to get the IDs for and attributes that need to be gotten.
 * @param {string} sectionDetails.section - The full name of the repeating section including the `repeating_` prefix.
 * @param {string[]} sectionDetails.fields - Array of field names that need to be gotten from the repeating section
 * @param {function(string[],sectionObj)} callback - The function to call once all IDs have been gotten and the array of repating attributes to get has been assembled. The callback is passed the array of repating attributes to get and a {@link sectionObj}.
 * @returns {void}
 */
const getSections = function(sectionDetails,callback){
  let queueClone = _.clone(sectionDetails);
  const worker = (queue,repeatAttrs=[],sections={})=>{
    let detail = queue.shift();
    getSectionIDs(detail.section,(IDs)=>{
      sections[detail.section] = IDs;
      IDs.forEach((id)=>{
        detail.fields.forEach((f)=>{
          repeatAttrs.push(`${detail.section}_${id}_${f}`);
        });
      });
      repeatAttrs.push(`_reporder_${detail.section}`);
      if(queue.length){
        worker(queue,repeatAttrs,sections);
      }else{
        callback(repeatAttrs,sections);
      }
    });
  };
  if(!queueClone[0]){
    callback([],{});
  }else{
    worker(queueClone);
  }
};
kFuncs.getSections = getSections;

// Sets the attributes while always calling with {silent:true}
// Can be awaited to get the values returned from _setAttrs
/**
 * Alias for [setAttrs()](https://wiki.roll20.net/Sheet_Worker_Scripts#setAttrs.28values.2Coptions.2Ccallback.29) that sets silently by default.
 * @name setAttrs
 * @param {object} obj - The object containting attributes to set
 * @param {boolean} [vocal=false] - Whether to set silently (default value) or not.
 * @param {function()} [callback] - The callback function to invoke after the setting has been completed. No arguments are passed to the callback function.
 * @returns {void}
 */
const set = function(obj,vocal=false,callback){
  setAttrs(obj,{silent:!vocal},callback);
};
kFuncs.setAttrs = set;

/**
 * Alias for generateRowID that adds the new id to the {@link sectionObj}. Also allows for creation of custom IDs that conform to the section ID requirements.
 * @name generateRowID
 * @param {string} section - The section name to create an ID for. The `repeating_` prefix is optional so both `repeating_equipment` and `equipment` are valid.
 * @param {sectionObj} sections
 * @param {string} [customText] - Custom text to start the ID with. This text should not be longer than the standard repeating section ID format.
 * @returns {any}
 */
const _generateRowID = function(section,sections,customText){
  let rowID = customText ?
    generateCustomID(customText) :
    generateRowID();
  section = section.match(/^repeating_[^_]+$/) ?
    section :
    `repeating_${section}`;
  sections[section] = sections[section] || [];
  sections[section].push(rowID);
  return `${section}_${rowID}`;
};
kFuncs.generateRowID = _generateRowID;/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
const listeners = {};
const baseGet = Object.entries(cascades).reduce((memo,[attrName,detailObj])=>{
  if(!/repeating/.test(attrName) && detailObj.type !== 'action'){
    memo.push(detailObj.name);
  }
  if(detailObj.listener){
    listeners[detailObj.listener] = detailObj.listenerFunc;
  }
  return memo;
},[]);
kFuncs.baseGet = baseGet;
const registerEventHandlers = function(){
  on('sheet:opened',updateSheet);
  debug({funcKeys:Object.keys(funcs),funcs});
  //Roll20 change and click listeners
  Object.entries(listeners).forEach(([event,funcName])=>{
    if(funcs[funcName]){
      on(event,funcs[funcName]);
    }else{
      debug(`!!!Warning!!! no function named ${funcName} found. No listener created for ${event}`,true);
    }
  });
  log(`kScaffold Loaded`);
};
setTimeout(registerEventHandlers,0);//Delay the execution of event registration to ensure all event properties are present.
return kFuncs;}());
  const trackerMonitors = ["repeating_health:clear","repeating_remnant structure:clear","repeating_structure:clear"];const navButtons = ["character","npc","settings","battle-remnant"];const actionAttributes = ["body_action","mind_action","spirit_action","initiative_action","repeating_skill_$x_action","repeating_weapon_$x_action","situational_awareness_action","remnant_initiative_action","assault_roll_action","strike_roll_action","motion_roll_action","repeating_drone_$x_assault_action","repeating_drone_$x_strike_action","repeating_remnant-weapon_$x_action","warbird_initiative_action","piloting_roll_action","strafing_roll_action","gunnery_roll_action","ordinance_roll_action","stunt_action","repeating_warbird-weapon_$x_action"];
  /*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Sheet Variables
k.sheetName = 'Outrider Studios\' Remnants';
k.version = 1.01;
const systemDefaults = {
  repeating_skill:{additional:true,alternate:true,fields:[
      {name:"archery / throwing",stat:"body",raw:1},
      {name:"athletics",stat:"body",raw:1},
      {name:"awareness",stat:"mind",raw:1},
      {name:"bureaucracy",stat:"mind",raw:1},
      {name:"command",stat:"mind or spirit",raw:1},
      {name:"craft",stat:"body / mind / spirit",raw:1},
      {name:"dodge",stat:"body",raw:1},
      {name:"etiquette",stat:"spirit",raw:1},
      {name:"history",stat:"mind",raw:1},
      {name:"investigation",stat:"mind / spirit",raw:1},
      {name:"language",stat:"mind",raw:1},
      {name:"larceny",stat:"mind / body / spirit",raw:1},
      {name:"lore",stat:"mind",raw:1},
      {name:"medicine",stat:"mind",raw:1},
      {name:"melee",stat:"body",raw:1},
      {name:"perform",stat:"spirit",raw:1},
      {name:"ride",stat:"body / spirit",raw:1},
      {name:"sail",stat:"mind / spirit",raw:1},
      {name:"sciences",stat:"mind",raw:1},
      {name:"social sciences",stat:"mind",raw:1},
      {name:"stealth",stat:"body",raw:1},
      {name:"survival",stat:"mind",raw:1},
      {name:"unarmed combat",stat:"body",raw:1}
    ]
  },
  repeating_health:{additional:true,alternate:true,fields:[
      {penalty:0},
      {penalty:-1},
      {penalty:-1}
    ]
  },
  repeating_structure:{additional:true,alternate:true,fields:[
      {penalty:0},
      {penalty:0},
      {penalty:-1},
      {penalty:-1},
      {penalty:-2}
    ]
  },
  system_header:'https://s3.amazonaws.com/files.d20.io/images/260489274/xCVgiDGF-dMYpVGKXL5UXA/original.png',
  health:3,
  health_max:3,
  structure:5,
  structure_max:5,
  structure_base:5,
  armour:5,
  speed:3,
  assault_damage:4,
  strike_damage:2,
  inspiring:1,
  terrifying:1,
  _defence_skill:'dodge'
};
const singulars = {
  remnants:'remnant'
};
const typeTabs = {
  character:{
    remove:['character','remnant'],
    add:['npc']
  },
  npc:{
    add:['character','remnant'],
    remove:['npc']
  }
};
const dynamicQueries = {};/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
/*
  Sheet Styling
*/
const styleOnOpen = function({attributes,sections,casc}){
  navigateSheet({triggerName:attributes.sheet_state});
  setActionCalls({attributes,sections});
};
k.registerFuncs({styleOnOpen},{type:['opener']});

const navigateSheet = function(event){
  k.debug('navigating sheet');
  const setObj = {};
  let [,,page] = k.parseClickTrigger(event.triggerName);
  page = page.replace(/^nav-|-action$/g,'');
  k.debug({navButtons});
  $20('.nav__button').removeClass('active');
  $20('.navigable-section').removeClass('active');
  $20(`.${page}`).addClass('active')
  setObj.sheet_state = page;
  k.debug({setObj});
  k.setAttrs(setObj);
};
k.registerFuncs({navigateSheet});

const setupSystem = function({attributes,sections}){
  setupAttributes(attributes,sections);
};
k.registerFuncs({setupSystem},{type:['new']});

const setupAttributes = function(attributes,sections){
  Object.entries(systemDefaults)
    .forEach(([section,properties])=>{
      k.debug({section});
      if(section.startsWith('_')){
        return;
      }
      if(/^repeating_/.test(section)){
        properties.fields.forEach((fieldObj)=>{
          let row = k.generateRowID(section,sections);
          Object.entries(fieldObj).forEach(([field,val])=>{
            attributes[`${row}_${field}`] = val;
          });
        })
      }else{
        attributes[section] = properties;
      }
    });
};/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Expands/collapses the sections
const expandHeader = function(jEvent){
  k.debug('entering expandHeader');
  const name = jEvent.htmlAttributes.name.replace(/act_/,'');
  const target = `.${name}.expandable-header`;
  k.getAttrs({props:['collapsed'],
    callback:(attributes)=>{
      attributes.collapsed = attributes.collapsed.split(/\s*,\s*/).filter(b => b!==name && !/^\s*$/.test(b) );
      if(!/collapse/.test(jEvent.htmlAttributes.class)){
        attributes.collapsed.push(name);
      }
      attributes.collapsed = attributes.collapsed.join(',');
      $20(target).toggleClass('collapse');
      attributes.set();
    }});
};
k.registerFuncs({expandHeader});

const clearTracker = function(event){
  k.debug('clearing tracker');
  let [section,rowID,field] = k.parseClickTrigger(event.triggerName);
  k.getAllAttrs({callback:(attributes,sections,casc)=>{
    sections[section].forEach((id)=>{
      attributes[`${section}_${id}_damaged`] = 0;
      attributes[`${section}_${id}_fill`] = 0;
    });
    let attr = section.replace(/repeating_/,'');
    attributes[attr] = attributes[`${attr}_max`];
    k.debug({attr});
    let trigger = casc[`attr_${attr}`];
    attributes.processChange({trigger,attributes,sections,casc});
  }});
};
k.registerFuncs({clearTracker});

const addItem = function(event){
  let [,,section] = k.parseClickTrigger(event.triggerName);
  section = section.replace(/add-/,'');
  let rowID = generateRowID();
  const setObj = {};
  setObj[`repeating_${section}_${rowID}_name`] = '';
  k.setAttrs(setObj);
};
k.registerFuncs({addItem});

const editSection = function(event){
  let [,,section] = k.parseClickTrigger(event.triggerName);
  section = section.replace(/edit-/,'');
  let target = `fieldset.repeating_${section} + .repcontainer`;
  $20(target).toggleClass('editmode');
};
k.registerFuncs({editSection});

const toggleImageInput = function(jEvent){
  let field = k.parseHTMLName(jEvent.htmlAttributes.name);
  $20(`.${field.replace(/_/g,'-')} .image-container__input`).toggleClass('active');
};
k.registerFuncs({toggleImageInput});

//Calls the appropriate dynamic query function for the event
const dynamicSelect = function(event){
  let[section,rowID,field] = parseClickTrigger(event.triggerName);
  field = field.replace(/-action$/,'');
  k.getAllAttrs({
    callback:async (attributes,sections)=>{
      let selection = await dynamicQueries[field]({section,rowID,field},attributes,sections);
      attributes[`${section}_${rowID}_${field}`] = selection;
      attributes[`${section}_${rowID}_translate_${field}`] = getTranslationByKey(selection) ? 1 : 0;
      attributes.set();
    }
  });
};
k.registerFuncs({dynamicSelect});/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Initial change functions
const syncHealth = function({trigger,attributes,sections}){
  k.debug('syncing token and character health');
  k.debug({sections,trigger});
  const type = trigger.name.replace(/_(?:mod|max)/,'');
  k.debug({type});
  let damage = attributes[`${type}_max`] - attributes[type];
  let damageIndex = damage - 1;
  sections[`repeating_${type}`].forEach((id,index)=>{
    attributes[`repeating_${type}_${id}_damaged`] = index === damageIndex ? 1 : 0;
    attributes[`repeating_${type}_${id}_fill`] = index < damageIndex ? 1 : 0;
  });
  if(attributes[type] > attributes[`${type}_max`]){
    attributes[type] = attributes[`${type}_max`];
  }
};
k.registerFuncs({syncHealth});/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
// Triggered Functions
const setActionCalls = function({attributes,sections}){
  k.debug('setting action calls');
  k.debug({actionAttributes});
  k.debug({attributes});
  k.debug({character_name:attributes.character_name,assault_roll_action:attributes.assault_roll_action});
  actionAttributes.forEach((base)=>{
    let [section,,field] = k.parseTriggerName(base);
    let fieldAction = field.replace(/_/g,'-');
    if(section){
      sections[section].forEach((id)=>{
        attributes[`${section}_${id}_${field}`] = `%{${attributes.character_name}|${section}_${id}_${fieldAction}}`;
      });
    }else{
      attributes[`${field}`] = `%{${attributes.character_name}|${fieldAction}}`;
    }
  });
};
k.registerFuncs({setActionCalls});

const checkHealth = function({trigger,attributes,sections}){
  k.debug('checking current health trackers')
  let [section,rowID] = k.parseRepeatName(trigger.name);
  let currDamage = sections[section].indexOf(rowID);
  sections[section].forEach((id,index)=>{
    if(index !== currDamage){
      attributes[`${section}_${id}_damaged`] =  0;
    }
    attributes[`${section}_${id}_fill`] = index < currDamage ? 1 : 0;
  });
};
k.registerFuncs({checkHealth});

const updateTrack = function({section,attributes,sections}){
  let newTracks = attributes[`${section}_max`] - sections[`repeating_${section}`].length;
  if(newTracks > 0){
    _.range(newTracks).forEach((n)=>{
      let newID = generateRowID();
      let priorPenalties = sections[`repeating_${section}`].slice(Math.max(0,sections[`repeating_${section}`].length - 2))
        .map((id)=>{
          return attributes[`repeating_${section}_${id}_penalty`];
        });
      let newPenalty;
      if(priorPenalties[0] !== priorPenalties[1]){
        newPenalty = priorPenalties[1] || priorPenalties[0];
      }else{
        let penStart = priorPenalties[1] || priorPenalties[0];
        newPenalty = Math.max(Math.min(-3,penStart),penStart - 1);
      }
      attributes[`repeating_${section}_${newID}_damaged`] = 0;
      attributes[`repeating_${section}_${newID}_penalty`] = newPenalty;
      sections[`repeating_${section}`].push(newID);
    });
  }else if(newTracks < 0){
    let slicePoint = Math.max(0,sections[`repeating_${section}`].length + newTracks);
    let extraTracks = sections[`repeating_${section}`].slice(slicePoint);
    extraTracks.forEach((id)=>{
      k.removeRepeatingRow(`repeating_${section}_${id}`,attributes,sections);
    });
  }
};
k.registerFuncs({updateTrack});

const maxHealth = function({type,attributes}){
  const typeSwitch = {
    structure:()=> attributes.structure_base,
    health:()=> 3 + attributes.body + attributes.body_mod + attributes.spirit + attributes.spirit_mod + attributes.health_mod
  }
  return Math.max(typeSwitch[type](),1);
};
k.registerFuncs({maxHealth});

const calcHealth = function({trigger,attributes,sections}){
  const type = trigger.name.replace(/_max/,'');
  k.debug(`calculating ${type}`);
  attributes[`${type}_max`] = maxHealth({type,attributes});
  let healthDiff = attributes[`${type}_max`] - k.value(attributes.attributes[`${type}_max`]);
  updateTrack({section:type,attributes,sections});
  attributes[type] = attributes[type] + healthDiff;
  syncHealth({trigger,attributes,sections});
};
k.registerFuncs({calcHealth});

const skillEffects = function({trigger,attributes,sections}){
  let [section,rowID,field] = k.parseRepeatName(trigger.name);
  let skillName = attributes[`${section}_${rowID}_name`];
  const skillSwitch = {
    awareness:['initiative']
  };
  skillSwitch[systemDefaults._defence_skill] = ['defence'];
  if(skillSwitch[skillName]){
    trigger.affects = [...trigger.affects,...skillSwitch[skillName]];
  }
};
k.registerFuncs({skillEffects});

const validateActionPenalty = function({attributes}){
  if(attributes.action_penalty > 0){
    attributes.action_penalty = attributes.action_penalty * -1;
  }
};
k.registerFuncs({validateActionPenalty});

const imageInput = function({trigger,attributes}){
  k.debug('setting image input');
  let [section,rowID,field] = k.parseTriggerName(trigger.name);
  if(!field) return;
  if(!attributes[field]){
    attributes[field] = 'https://s3.amazonaws.com/files.d20.io/images/259054779/OzN3yQwg7MbfXNtMYs-iOg/original.png';
  }
  $20(`.${field.replace(/_/g,'-')} .image-container__input`).removeClass('active');
};
k.registerFuncs({imageInput});

const displayCharacterTypeSections = function({attributes}){
  let typeObj = typeTabs[attributes.sheet_type];
  Object.entries(typeObj).forEach(([action,targetArray])=>{
    k.debug({action,targetArray});
    targetArray.forEach((target)=>{
      $20(`.${target}`)[`${action}Class`]('inactive');
    });
  });
};
k.registerFuncs({displayCharacterTypeSections},{type:['opener']});const determinePenalty = function(type,attributes,sections){
  let damageID = sections[`repeating_${type}`].find((id)=> attributes[`repeating_${type}_${id}_damaged`] === 1);
  return damageID ?  attributes[`repeating_${type}_${damageID}_penalty`] : 0;
};

const calcInitiative = function({trigger,attributes,sections}){
  if(attributes.sheet_type === 'npc'){
    return attributes.initiative;
  }
  let awarenessID = sections.repeating_skill.find((id)=>attributes[`repeating_skill_${id}_name`] === 'awareness');
  let awareness = attributes[`repeating_skill_${awarenessID}_level`];
  return awareness + attributes.mind + attributes.initiative_mod;
};
k.registerFuncs({calcInitiative});

const calcDefence = function({trigger,attributes,sections}){
  if(attributes.sheet_type === 'npc'){
    return attributes.defence;
  }
  const defenceSkillID = sections.repeating_skill.find((id)=>attributes[`repeating_skill_${id}_name`] === systemDefaults._defence_skill);
  const defenceSkill = attributes[`repeating_skill_${defenceSkillID}_level`];
  const damagePenalty = determinePenalty('health',attributes,sections);
  const actionPenalty = attributes.action_penalty_automation === 'use input' ?
    attributes.action_penalty :
    0;
  const total =  3 + attributes.body + defenceSkill + attributes.shield_bonus + damagePenalty + attributes.defence_mod + actionPenalty;
  return Math.max(total,0);
};
k.registerFuncs({calcDefence});

const totalHealth = function({trigger,attributes,sections}){
  const type = trigger.name.replace(/_max/,'');
  k.debug(`calculating total ${type}`);
  return sections[`repeating_${type}`].reduce((total,id)=>{
    total -= attributes[`repeating_${type}_${id}_damaged`] + attributes[`repeating_${type}_${id}_fill`];
    return total;
  },attributes[`${type}_max`]);
};
k.registerFuncs({totalHealth});

const calcResist = function({attributes}){
  if(attributes.sheet_type === 'npc'){
    return attributes.resist;
  }
  return Math.max(attributes.spirit + attributes.armour_bonus + attributes.resist_mod,0);
};
k.registerFuncs({calcResist});

const calcSA = function({attributes}){
  if(attributes.sheet_type === 'npc'){
    return attributes.situational_awareness;
  }
  return ['body','mind','spirit'].reduce((m,attr)=>{
    return m + attributes[attr];
  },0);
};
k.registerFuncs({calcSA});/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Roll Functions
//Begins the parsing of a roll
const skillRollDetails = function({section,rowID,sections,attributes,rollObj,actionPenalty}){
  rollObj.header = attributes[`${section}_${rowID}_name`];
  rollObj.header = attributes[`${section}_${rowID}_raw`] ? `^{${rollObj.header}}` : rollObj.header;
  let skill = attributes[`${section}_${rowID}_level`];
  let stat = attributes[`${section}_${rowID}_stat`];
  let penalty = determinePenalty('health',attributes,sections);
  if(stat === 'query'){
    stat = `?{${getTranslationByKey('stat query')}|${['body','mind','spirit'].map((s)=>`${getTranslationByKey(s)},@{${s}}[${s}]`).join('|')}}`;
  }else{
    stat = `[[0@{${stat}}]][${stat}]`;
  }
  rollObj.roll = `[[1d6 + ${stat} + [[0${skill}]][${rollObj.header}] + ${penalty}[Damage Penalty]${actionPenalty}]]`;
};

//determines which health track's penalties should affect an attribute
const determineHealthType = function(section,field){
  const attrCharacterLookup = {
    'situational-awareness':'structure',
    'remnant-initiative':'structure',
    'assault-roll':'structure',
    'strike-roll':'structure',
    'motion-roll':'structure',
    repeating_drone:'structure',
    'repeating_remnant-weapon':'structure'
  };
  return attrCharacterLookup[section] || attrCharacterLookup[field] || 'health';
};

const weaponRollDetails = function({section,rowID,field,sections,attributes,rollObj,actionPenalty}){
  rollObj.header = attributes[`${section}_${rowID}_name`];
  let skill;
  let stat;
  let healthType = determineHealthType(section,field);
  let penalty = determinePenalty(healthType,attributes,sections);
  k.debug({healthType,penalty});
  if(section === 'repeating_weapon'){
    let skillID = sections.repeating_skill.find((id)=>attributes[`repeating_skill_${id}_name`] === attributes[`${section}_${rowID}_skill`]);
    let skillRef = `repeating_skill_${skillID}`;
    skill = attributes[`${skillRef}_level`];
    stat = attributes[`${skillRef}_stat`];
    if(stat === 'query'){
      stat = `?{${getTranslationByKey('stat query')}|${['body','mind','spirit'].map((s)=>`${getTranslationByKey(s)},@{${s}}[${s}]`).join('|')}}`;
    }else{
      stat = `@{${stat}}[${stat}]`;
    }
    rollObj.roll = `[[1d6 + ${stat} + ${skill}[${attributes[`${skillRef}_name`]}] + ${penalty}[Damage Penalty]${actionPenalty}]]`;
    rollObj.damage = `[[${attributes[`${section}_${rowID}_damage`]} + Lead]]`;
  }else if(section === 'repeating_remnant-weapon'){
    let skillName = attributes[`${section}_${rowID}_skill`];
    skill = attributes[`${skillName}_level`];
    stat = attributes.situational_awareness;
    rollObj.roll = `[[1d6 + [[0${stat}]][SA] + [[0${skill}]][${skillName}] + [[0${attributes[`${section}_${rowID}_bonus`]}]] + ${penalty}[Damage Penalty]${actionPenalty} ]]`;
    rollObj.damage = `[[${attributes[`${section}_${rowID}_damage`]+ attributes[`${section}_${rowID}_damage_bonus`]} + Lead]]`;
  }
  k.debug({roll:rollObj.roll});
  rollObj.description = `@{${section}_${rowID}_notes}`;
};

const droneRollDetails = async function({section,rowID,field,attributes,rollObj,actionPenalty}){
  rollObj.header = attributes[`${section}_${rowID}_name`];
  let numQuery = _.range(attributes[`${section}_${rowID}_active`]).map((num)=>{
    return num +1;
  });
  let attackNum;
  k.debug({numQuery});
  if(numQuery.length <= 1){
    attackNum = await k.pseudoQuery(1);
  }else{
    attackNum = await k.extractQueryResult(`${getTranslationByKey('drone query')}|${numQuery.join('|')}`);
  }
  k.debug({attackNum});
  attackNum = +attackNum;
  let bonus = Math.floor(attackNum / 2);
  _.range(attackNum).forEach((n)=>{
    let num = n+1;
    rollObj[`roll${num}`] = `[[1d6 + [[0@{${section}_${rowID}_${field}}]][${field}] + ${bonus}[multiple attack]${actionPenalty}]]`;
    rollObj[`status${num}`] = `[[0[computed value]]]`;
  });
  rollObj.damage = `[[${attributes[`${section}_${rowID}_${field}_dam`]} + Lead]]`;
  rollObj.description = `@{${section}_${rowID}_description}`;
  if(field === 'strike'){
    rollObj.description = `^{strike range}: @{${section}_${rowID}_strikerange}\n@{${section}_${rowID}_description}`;
  }
};

const initiateRoll = function(event){
  let [section,rowID,field] = k.parseTriggerName(event.triggerName);
  field = field.replace(/-action/,'');
  const rollSwitch = {
    repeating_weapon:weaponRollDetails,
    repeating_skill:skillRollDetails,
    'repeating_remnant-weapon':weaponRollDetails,
    repeating_drone:droneRollDetails
  };
  k.getAllAttrs({props:['difficulty','action_penalty_automation',...k.baseGet],callback:async (attributes,sections)=>{
    let rollObj = {status:'[[0[computed value]]]'};
    let actionPenalty = determineActionPenalty(attributes);
    if(/^(?:assault|strike|motion)-roll$/.test(field)){
      let penalty = determinePenalty('structure',attributes,sections);
      field = field.replace(/-roll/,'');
      rollObj.header = `^{${field}}`;
      rollObj.roll = `[[1d6 + [[0@{${field}_level}]][${field}] + [[0@{situational_awareness}]][SA] + ${penalty}[Damage Penalty]${actionPenalty}]]`;
      rollObj.damage = /assault|strike/.test(field) ? `[[[[0@{${field}_damage}]] + Lead]]` : undefined;
    }else if(!section){
      //Base rolling for simple stats
      let healthType = determineHealthType(section,field);
      let penalty = determinePenalty(healthType,attributes,sections);
      rollObj.header = `^{${field.replace(/-/g,' ')}}`;//output translation of name
      rollObj.roll = `[[1d6 + [[0@{${field.replace(/-/g,'_')}}]][${field.replace(/-/g,' ')}] + ${penalty}[Damage Penalty]${actionPenalty}${/initiative/.test(field) ? '&{tracker}' : ''}]]`;
    }else{
      //rolling for more complex fields. These are typically repeating sections
      if(section === 'repeating_drone'){
        await rollSwitch[section]({section,rowID,field,sections,attributes,rollObj,actionPenalty});
      }else{
        rollSwitch[section]({section,rowID,field,sections,attributes,rollObj,actionPenalty});
      }
    }
    if(attributes.difficulty && !/initiative/.test(field)){
      rollObj.difficulty = `[[?{${getTranslationByKey('difficulty query')}|0}]]`;
      rollObj.damage_label = rollObj.damage ? undefined : '[[0[computed value]]]';
      rollObj.damage = rollObj.damage || `[[0[computed value]]]`;
    }
    if(!rollObj.damage && !rollObj.difficulty){
      rollObj.singleroll = 'true';
    }
    executeRoll(rollObj);
  }});
};
k.registerFuncs({initiateRoll});

const determineActionPenalty = function(attributes){
  const stateSwitch = {
    disabled:'',
    ask:`+ [[abs(0?{${getTranslationByKey('action penalty query')}|0}) * -1]][Action Penalty]`,
    'use input':`+ ${attributes.action_penalty}[Action Penalty]`
  };
  return stateSwitch[attributes.action_penalty_automation];
};

const executeRoll = async function(rollObj){
  let rollText = Object.entries(rollObj).reduce((text,[field,content])=>{
    if(content){
      text += `{{${field}=${content}}}`;
    }
    return text;
  },'@{template_start}');
  let roll = await startRoll(rollText);
  const computeObj = {};
  if(roll.results.roll1){
    computeMultipleRolls(roll.results,computeObj,rollObj);
  }else{
    computeSingleRoll(roll.results,computeObj,rollObj);
  }
  finishRoll(roll.rollId,computeObj);
};

const computeMultipleRolls = function(results,computeObj,rollObj){
  let rollNums = [6,5,4,3,2,1].find((num)=>results.hasOwnProperty(`roll${num}`));
  computeObj[`damage`] = rollObj[`damage`] && rollObj.difficulty ? 0 : undefined;
  _.range(rollNums).forEach((n)=>{
    let num = n + 1;
    if(rollObj[`damage`] && rollObj.difficulty){
      let damage = results[`damage`].result + (results[`roll${num}`].result - results.difficulty.result);
      if(damage < results[`damage`].result){
        damage = 0;
      }
      computeObj.damage += damage;
    }
    if(rollObj.difficulty){
      computeObj[`status`] = checkResult(results[`roll${num}`],results.difficulty);
    }
  });
};

const computeSingleRoll = function(results,computeObj,rollObj){
  if(rollObj.damage && rollObj.difficulty){
    computeObj.damage = results.damage.result + (results.roll.result - results.difficulty.result);
  }
  if(results.damage_label){
    computeObj.damage_label = getTranslationByKey(computeObj.damage < 0 ? 'trail' : 'lead');
  }
  if(rollObj.difficulty){
    computeObj[`status`] = checkResult(results[`roll`],results.difficulty);
  }
};

const checkResult = function(roll,difficulty){
  return roll.result - difficulty.result;
};/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Calculation Functions
const calcRemnantInitiative = function({trigger,attributes,sections}){
  k.debug('calculating remnant initiative');
  let awarenessID = sections.repeating_skill.find((id)=>attributes[`repeating_skill_${id}_name`] === 'awareness');
  let awareness = attributes[`repeating_skill_${awarenessID}_level`];
  let penalty = determinePenalty('structure',attributes,sections);
  return attributes.situational_awareness + awareness + penalty;
};
k.registerFuncs({calcRemnantInitiative});

const calcRemnantDefence = function({trigger,attributes,sections}){
  k.debug('calculating remnant defence');
  let damagePenalty = determinePenalty('structure',attributes,sections);
  k.debug({damagePenalty});
  return Math.max(attributes.speed + attributes.situational_awareness + attributes.motion_level + damagePenalty,0);
};
k.registerFuncs({calcRemnantDefence});

const calcStrikeRange = function({trigger,attributes,sections}){
  k.debug('calculating strike range');
  const [section,rowID,field] = k.parseTriggerName(trigger.name);
  let strike = section ? `${section}_${rowID}_strike` : 'strike_level';
  return attributes[strike] * 100;
};
k.registerFuncs({calcStrikeRange});

const calcRemnantDamage = function({trigger,attributes,sections}){
  k.debug('calculating remnant damage');
  let [section,rowID,field] = k.parseTriggerName(trigger.name);
  let skill = attributes[`${section}_${rowID}_skill`];
  return attributes[`${skill}_damage`] + attributes[`${section}_${rowID}_damage_bonus`];
};
k.registerFuncs({calcRemnantDamage});/*jshint esversion: 11, laxcomma:true, eqeqeq:true*/
/*jshint -W014,-W084,-W030,-W033*/
//Update functions. These functions should be added to the updateHandlers object for iteration through by the updateSheet function.
const update1x01 = function({attributes,sections}){
  sections.repeating_drone.forEach((id)=>{
    attributes[`repeating_drone_${id}_struct`] = attributes[`repeating_drone_${id}_structure`];
    attributes[`repeating_drone_${id}_struct_max`] = attributes[`repeating_drone_${id}_structure_max`];
  });
};
k.registerFuncs({'1.01':update1x01},{type:['updater']})
</script>